<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EndoTool ‚Äî Evidence-Based Endometriosis Guide</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fafafa;--surface:#fff;--surface-alt:#f6f4f1;--highlight:#fef7f4;
  --primary:#c44536;--primary-dk:#a63729;--primary-lt:#fef2ef;--primary-glow:rgba(196,69,54,.1);
  --accent:#2b6b50;--accent-lt:#edf5f1;
  --text:#1a1a1a;--text2:#4a4a4a;--muted:#7a7a7a;--faint:#aaa;
  --border:#e5e5e5;--border-hov:#ccc;
  --alert-bg:#fef2ef;--alert-border:#e07060;--alert-text:#8b2e20;
  --font-d:'Fraunces',Georgia,serif;--font-b:'Plus Jakarta Sans',-apple-system,sans-serif;
  --max:620px;--r:12px;--rl:16px;
}
*,*::before,*::after{box-sizing:border-box}
html{scroll-behavior:smooth}
body{margin:0;font-family:var(--font-b);background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;line-height:1.5}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#ddd;border-radius:3px}

@keyframes fadeIn{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideR{from{opacity:0;transform:translateX(28px)}to{opacity:1;transform:translateX(0)}}
@keyframes slideL{from{opacity:0;transform:translateX(-28px)}to{opacity:1;transform:translateX(0)}}
@keyframes fadeSlide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pop{0%{transform:scale(.95);opacity:0}100%{transform:scale(1);opacity:1}}
.anim-f{animation:slideR .28s ease}.anim-b{animation:slideL .28s ease}.anim-fade{animation:fadeIn .3s ease}

.wrap{max-width:var(--max);margin:0 auto;padding:0 24px}
@media(min-width:660px){.wrap{padding:0}}

/* Header */
.hdr{padding-top:36px;margin-bottom:8px}
.hdr__brand{display:flex;align-items:center;gap:12px;margin-bottom:6px}
.hdr__logo{font-family:var(--font-d);font-size:30px;font-weight:700;color:var(--text);letter-spacing:-1px}
.hdr__badge{font-size:10px;color:var(--primary);font-weight:700;letter-spacing:1.5px;text-transform:uppercase;background:var(--primary-lt);padding:4px 10px;border-radius:6px}
.hdr__tag{font-size:14.5px;color:var(--muted);line-height:1.6;margin:0 0 24px}

/* Progress */
.prog{margin-bottom:28px}
.prog__bar{display:flex;gap:6px;margin-bottom:10px}
.prog__seg{flex:1;height:5px;border-radius:3px;background:var(--border);transition:all .4s ease}
.prog__seg.on{background:var(--primary);box-shadow:0 1px 4px rgba(196,69,54,.3)}
.prog__lbl{display:flex;justify-content:space-between;font-size:13px}
.prog__n{color:var(--faint);font-weight:500}.prog__name{color:var(--text2);font-weight:600}

/* Main */
.main{min-height:200px}
.stitle{font-family:var(--font-d);font-size:28px;font-weight:700;color:var(--text);margin:0 0 6px;line-height:1.2;letter-spacing:-.5px}
.shint{font-size:15px;color:var(--muted);line-height:1.6;margin-bottom:24px}

/* Nav */
.nav{display:flex;justify-content:space-between;align-items:center;padding:28px 0 44px}
.nbtn{border-radius:var(--r);font-size:14px;font-weight:600;cursor:pointer;transition:all .2s ease;font-family:var(--font-b)}
.nb-back{padding:10px 20px;border:1.5px solid var(--border);background:var(--surface);color:var(--text2)}
.nb-back:hover{border-color:var(--border-hov);color:var(--text)}
.nb-next{border:none;background:var(--primary);color:#fff;padding:12px 32px;font-size:15px;box-shadow:0 2px 8px rgba(196,69,54,.25)}
.nb-next:hover:not(:disabled){background:var(--primary-dk);box-shadow:0 4px 14px rgba(196,69,54,.35);transform:translateY(-1px)}
.nb-next:disabled{background:#d5d5d5;box-shadow:none;cursor:default}

/* ============ AGE CALIPER ============ */
.age-slider{margin:32px 0 36px;user-select:none}
.age-slider__label{font-size:15px;font-weight:700;margin-bottom:16px;color:var(--text)}
.age-slider__track-wrap{position:relative;padding:0 12px}
.age-slider__track{position:relative;height:6px;background:#e8e5e2;border-radius:3px;margin-bottom:12px}
.age-slider__fill{position:absolute;left:0;top:0;height:100%;background:var(--primary);border-radius:3px;transition:width .15s ease}
.age-slider__thumb{position:absolute;top:50%;width:28px;height:28px;border-radius:50%;background:var(--primary);border:3px solid #fff;box-shadow:0 2px 8px rgba(196,69,54,.35);transform:translate(-50%,-50%);cursor:grab;transition:box-shadow .15s ease;z-index:2}
.age-slider__thumb:hover,.age-slider__thumb:active{box-shadow:0 4px 16px rgba(196,69,54,.45)}
.age-slider__thumb:active{cursor:grabbing;transform:translate(-50%,-50%) scale(1.1)}
.age-slider__value{position:absolute;top:-36px;left:50%;transform:translateX(-50%);background:var(--text);color:#fff;font-size:13px;font-weight:700;padding:4px 12px;border-radius:8px;white-space:nowrap}
.age-slider__value::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:var(--text)}
.age-slider__ticks{display:flex;justify-content:space-between;padding:0 2px}
.age-slider__tick{font-size:12px;color:var(--faint);font-weight:500;transition:color .2s ease;cursor:pointer;padding:4px 0}
.age-slider__tick.on{color:var(--primary);font-weight:700}

/* ============ SYMPTOM CARDS ============ */
.sym-grid{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}
.sym-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--rl);overflow:hidden;transition:all .2s ease}
.sym-card.has-sel{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.sym-card__head{display:flex;align-items:center;gap:12px;padding:16px 20px;cursor:pointer;user-select:none}
.sym-card__icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.sym-card__info{flex:1;min-width:0}
.sym-card__title{font-size:15px;font-weight:700;color:var(--text);line-height:1.3}
.sym-card__sub{font-size:12.5px;color:var(--muted);margin-top:1px}
.sym-card__count{font-size:12px;font-weight:700;color:var(--primary);background:var(--primary-lt);padding:3px 10px;border-radius:20px;white-space:nowrap}
.sym-card__arrow{font-size:14px;color:var(--faint);transition:transform .2s ease;margin-left:4px}
.sym-card.open .sym-card__arrow{transform:rotate(180deg)}
.sym-card__body{max-height:0;overflow:hidden;transition:max-height .3s ease}
.sym-card.open .sym-card__body{max-height:800px}
.sym-card__inner{padding:0 20px 16px;display:flex;flex-direction:column;gap:6px}

/* Symptom chip (inside cards) */
.schip{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:1.5px solid #eee;background:#fafafa;cursor:pointer;transition:all .15s ease;font-size:14px;color:var(--text2);line-height:1.4}
.schip:hover{border-color:var(--border-hov);background:#f5f5f5}
.schip.on{border-color:var(--primary);background:var(--primary-lt);color:var(--text)}
.schip input{display:none}
.schip__box{width:18px;height:18px;border-radius:5px;border:2px solid #ccc;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s ease}
.schip.on .schip__box{border-color:var(--primary);background:var(--primary)}
.schip__box svg{display:none}.schip.on .schip__box svg{display:block}

/* Red flag special */
.sym-card--alert{border-color:var(--alert-border)}
.sym-card--alert .sym-card__icon{background:var(--alert-bg)}

/* Alert */
.alert{background:var(--alert-bg);border:2px solid var(--alert-border);border-radius:var(--r);padding:16px 20px;margin-bottom:20px;display:flex;gap:12px;align-items:flex-start;animation:fadeSlide .3s ease}
.alert__icon{font-size:18px;line-height:1.4;flex-shrink:0}
.alert__text{font-size:14px;color:var(--alert-text);line-height:1.6;font-weight:500}

/* ============ STANDARD FIELDS (screens 3-5) ============ */
.fg{margin-bottom:28px}
.fg__lbl{font-size:15px;font-weight:700;color:var(--text);margin-bottom:4px}
.fg__hint{font-size:13px;color:var(--muted);margin-bottom:10px;line-height:1.5}
.fg__opts{display:flex;flex-direction:column;gap:6px}

.opt{display:flex;align-items:flex-start;gap:12px;padding:12px 16px;border-radius:var(--r);border:1.5px solid var(--border);background:var(--surface);cursor:pointer;transition:all .15s ease;font-size:14.5px;line-height:1.5;color:var(--text2);user-select:none}
.opt:hover{border-color:var(--border-hov)}
.opt.on{border-color:var(--primary);background:var(--primary-lt);color:var(--text);box-shadow:0 0 0 3px var(--primary-glow)}
.opt input{display:none}
.opt__chk{width:20px;min-width:20px;height:20px;border-radius:6px;border:2px solid #ccc;display:flex;align-items:center;justify-content:center;margin-top:1px;transition:all .15s ease;flex-shrink:0}
.opt:hover .opt__chk{border-color:#aaa}
.opt.on .opt__chk{border-color:var(--primary);background:var(--primary)}
.opt__chk svg{display:none}.opt.on .opt__chk svg{display:block}
.opt__rad{width:20px;min-width:20px;height:20px;border-radius:50%;border:2px solid #ccc;display:flex;align-items:center;justify-content:center;transition:all .15s ease;flex-shrink:0}
.opt:hover .opt__rad{border-color:#aaa}
.opt.on .opt__rad{border-color:var(--primary)}
.opt__dot{width:10px;height:10px;border-radius:50%;background:var(--primary);display:none}
.opt.on .opt__dot{display:block}

.sub-q{margin-left:16px;padding-left:16px;border-left:3px solid var(--primary-lt);margin-bottom:16px;margin-top:8px;animation:fadeSlide .3s ease}

.opills{display:flex;gap:6px;margin-top:8px;margin-left:48px;flex-wrap:wrap}
.opill{padding:5px 14px;border-radius:20px;font-size:12px;font-weight:600;border:1.5px solid var(--border);background:var(--surface);color:var(--muted);cursor:pointer;transition:all .15s ease;font-family:var(--font-b)}
.opill:hover{border-color:var(--border-hov);color:var(--text2)}
.opill.on{border-color:var(--primary);background:var(--primary);color:#fff}

/* ============ SUMMARY / REVIEW ============ */
.scard{background:var(--surface);border-radius:var(--rl);padding:28px;margin-bottom:20px;border:1.5px solid var(--border)}
.scard__t{font-family:var(--font-d);font-size:20px;font-weight:700;margin-bottom:16px;letter-spacing:-.3px}
.scard p{font-size:14px;line-height:1.7;color:var(--text2);margin:0 0 10px}
.scard p:last-child{margin-bottom:0}
.scard strong{color:var(--text);font-weight:600}
.scard__rf{background:var(--alert-bg);border:1.5px solid var(--alert-border);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--alert-text);font-weight:600}

.ftcard{background:linear-gradient(135deg,#edf5f1,#e5f0ea);border-radius:var(--rl);padding:20px 24px;margin-bottom:20px;border:1.5px solid #b8d4c8}
.ftcard__hdr{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.ftcard__t{font-size:15px;font-weight:700;color:var(--accent)}
.ftcard__txt{font-size:14px;color:var(--text2);line-height:1.6}

.gen-area{text-align:center;padding:28px 0 8px;border-top:1.5px solid var(--border);margin-top:12px}
.gen-area__hint{font-size:14px;color:var(--muted);margin-bottom:20px;line-height:1.6}
.btn-gen{padding:16px 48px;border-radius:14px;border:none;background:var(--primary);color:#fff;font-size:17px;font-weight:700;cursor:pointer;font-family:var(--font-b);box-shadow:0 4px 20px rgba(196,69,54,.3);transition:all .25s ease}
.btn-gen:hover{background:var(--primary-dk);box-shadow:0 6px 28px rgba(196,69,54,.4);transform:translateY(-2px)}
.gen-area__disc{font-size:12px;color:var(--faint);margin-top:16px;line-height:1.6}

/* ============ OUTPUT / REPORT ============ */
.out{padding-top:20px;padding-bottom:60px}
.out__hdr{margin-bottom:36px;padding-bottom:28px;border-bottom:2px solid var(--border)}
.out__t{font-family:var(--font-d);font-size:30px;font-weight:700;margin:0 0 8px;letter-spacing:-.7px;line-height:1.2}
.out__sub{font-size:15px;color:var(--muted);line-height:1.6}

.rsec{margin-bottom:40px;animation:fadeIn .4s ease}
.rsec__n{font-size:11px;font-weight:800;color:var(--primary);text-transform:uppercase;letter-spacing:2px;margin-bottom:6px}
.rsec__t{font-family:var(--font-d);font-size:22px;font-weight:700;margin:0 0 16px;line-height:1.25;letter-spacing:-.4px}
.rsec__c{font-size:15px;line-height:1.75;color:var(--text2)}
.rsec__c p{margin:0 0 16px}.rsec__c p:last-child{margin:0}
.rsec__c strong{color:var(--text);font-weight:600}

.cite{display:inline;font-size:10.5px;font-weight:700;color:var(--accent);background:var(--accent-lt);padding:2px 7px;border-radius:4px;margin-left:2px;white-space:nowrap;vertical-align:middle;letter-spacing:.3px;cursor:help;position:relative}
.cite:hover{background:#d6e8df}
.cite[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1a1a1a;color:#fff;font-size:12px;font-weight:500;padding:8px 14px;border-radius:8px;white-space:normal;z-index:100;max-width:300px;line-height:1.4;box-shadow:0 4px 12px rgba(0,0,0,.25);min-width:180px;text-align:left;pointer-events:none}
.ev{display:inline-block;font-size:10.5px;font-weight:700;padding:2px 8px;border-radius:5px;margin-left:3px;vertical-align:middle}
.ev--strong{background:#e3f2fd;color:#1565c0}
.ev--high{background:#e8f5e9;color:#2e7d32}
.ev--mod{background:#fff3e0;color:#e65100}
.ev--low{background:#fce4ec;color:#c62828}

.src-leg{background:var(--surface);border-radius:var(--rl);padding:24px 28px;margin-top:32px;margin-bottom:24px;border:1.5px solid var(--border)}
.src-leg__t{font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px}
.src-leg__r{display:flex;gap:12px;padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:13px;align-items:baseline}
.src-leg__r:last-child{border-bottom:none}
.src-leg__c{font-weight:700;color:var(--accent);min-width:70px;font-size:12px}
.src-leg__n{color:var(--text2);flex:1}
.src-leg__y{color:var(--muted);font-weight:600;font-size:12px}

.blocked{background:#fffbf0;border:2px solid #f0c040;border-radius:var(--r);padding:16px 20px;margin-bottom:16px}
.blocked__t{font-size:14px;color:#7a5e1a;line-height:1.6;font-weight:500}

.gpq{background:var(--surface);border-radius:var(--rl);padding:24px 28px;margin-top:16px;border:1.5px solid var(--border)}
.gpq__t{font-size:16px;font-weight:700;margin-bottom:14px}
.gpq__l{list-style:none;padding:0;margin:0}
.gpq__l li{font-size:14px;color:var(--text2);line-height:1.65;padding:8px 0 8px 28px;position:relative;border-bottom:1px solid #f0f0f0}
.gpq__l li:last-child{border-bottom:none}
.gpq__l li::before{content:"‚Üí";position:absolute;left:0;color:var(--primary);font-weight:700;font-size:15px}

.ftcta{background:linear-gradient(135deg,#edf5f1,#e5f0ea);border:2px solid #b8d4c8;border-radius:var(--rl);padding:20px 24px;margin-top:20px;cursor:pointer;transition:all .2s ease}
.ftcta:hover{border-color:var(--accent);box-shadow:0 4px 16px rgba(43,76,63,.12);transform:translateY(-1px)}
.ftcta__l{font-size:10px;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px}
.ftcta__t{font-family:var(--font-d);font-size:17px;font-weight:700;margin-bottom:6px;letter-spacing:-.3px}
.ftcta__txt{font-size:14px;color:var(--text2);line-height:1.6}

/* ============ PERSONAL BLURB (Fertool) ============ */
.blurb{position:relative;border-radius:20px;padding:36px 32px;margin-bottom:40px;animation:pop .4s ease;overflow:hidden;background:linear-gradient(135deg,#1a2e26 0%,#2b4c3f 40%,#1e3a30 100%);color:#fff}
.blurb::before{content:'';position:absolute;top:-60%;right:-20%;width:300px;height:300px;background:radial-gradient(circle,rgba(255,255,255,.06) 0%,transparent 70%);border-radius:50%}
.blurb::after{content:'';position:absolute;bottom:-40%;left:-10%;width:250px;height:250px;background:radial-gradient(circle,rgba(196,69,54,.15) 0%,transparent 70%);border-radius:50%}
.blurb__inner{position:relative;z-index:1}
.blurb__badge{display:inline-flex;align-items:center;gap:6px;font-size:10px;font-weight:800;letter-spacing:2px;text-transform:uppercase;background:rgba(255,255,255,.12);backdrop-filter:blur(4px);padding:5px 14px;border-radius:8px;margin-bottom:20px;color:rgba(255,255,255,.8);border:1px solid rgba(255,255,255,.1)}
.blurb__greeting{font-family:var(--font-d);font-size:26px;font-weight:700;line-height:1.25;letter-spacing:-.5px;margin-bottom:20px}
.blurb__body{font-size:15.5px;line-height:1.8;color:rgba(255,255,255,.88)}
.blurb__body p{margin:0 0 14px}
.blurb__body p:last-child{margin:0}
.blurb__body strong{color:#fff;font-weight:600}
.blurb__body em{font-style:normal;color:#a8d8c0}
.blurb__actions{margin-top:24px;padding-top:20px;border-top:1px solid rgba(255,255,255,.12);display:flex;flex-wrap:wrap;gap:10px}
.blurb__action{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px 18px;font-size:13px;font-weight:600;color:rgba(255,255,255,.9);backdrop-filter:blur(4px)}
.blurb__action-n{width:22px;height:22px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800}
.blurb__note{margin-top:20px;font-size:12px;color:rgba(255,255,255,.45);line-height:1.5;font-style:italic}

/* ---- Fertool Search Component (matches Fertool production) ---- */
/* ---- Fertool Component ---- */
.fertool-box{background:#f4f7f4;border-radius:16px;padding:32px;margin-bottom:36px;animation:fadeIn .4s ease}
.fertool-box__badge{display:inline-block;font-size:11px;font-weight:700;color:#4a6b52;background:#dce8de;padding:5px 16px;border-radius:20px;letter-spacing:.8px;text-transform:uppercase;margin-bottom:16px}
.fertool-box__title{font-family:var(--font-d);font-size:26px;font-weight:400;color:#2a3a2e;margin:0 0 20px;letter-spacing:-.3px;line-height:1.3}
.fertool-box__wrap{display:flex;gap:0;background:#fff;border-radius:12px;border:1.5px solid #ddd;overflow:hidden;transition:border-color .2s ease}
.fertool-box__wrap:focus-within{border-color:#8aab91;box-shadow:0 0 0 3px rgba(138,171,145,.15)}
.fertool-box__input{flex:1;border:none;padding:16px 20px;font-size:15px;color:#2a3a2e;font-family:var(--font-b);outline:none;background:transparent}
.fertool-box__input::placeholder{color:#a0a0a0}
.fertool-box__btn{background:#4a6b52;border:none;padding:12px 24px;font-size:14px;font-weight:600;color:#fff;cursor:pointer;font-family:var(--font-b);transition:background .2s ease;margin:6px;border-radius:8px;white-space:nowrap}
.fertool-box__btn:hover{background:#3d5a44}
.fertool-box__response{margin-top:20px;background:#fff;border-radius:12px;padding:24px;border:1.5px solid #dce8de;animation:fadeSlide .3s ease;display:none}
.fertool-box__response.show{display:block}
.fertool-box__response-q{font-size:11px;font-weight:700;color:#8a9b8e;text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px}
.fertool-box__response-a{font-size:15px;line-height:1.75;color:#2a3a2e}
.fertool-box__response-a p{margin:0 0 12px}
.fertool-box__response-a p:last-child{margin:0}
.fertool-box__response-a strong{font-weight:600}
.fertool-box__response-src{margin-top:14px;padding-top:12px;border-top:1px solid #eee;font-size:11px;color:#8a9b8e}
.fertool-box__chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:14px}
.fertool-box__chip{background:#fff;border:1.5px solid #dce8de;border-radius:20px;padding:7px 16px;font-size:13px;color:#4a6b52;cursor:pointer;font-family:var(--font-b);transition:all .15s ease}
.fertool-box__chip:hover{background:#eef4f0;border-color:#8aab91}
.fertool-box__loading{display:none;margin-top:16px;font-size:14px;color:#8a9b8e;font-style:italic}
.fertool-box__loading.show{display:block}
.fertool-box__response-label{font-size:11px;font-weight:700;color:#8a9b8e;text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px}

/* ---- Report loading + streaming ---- */
.report-loading{text-align:center;padding:60px 20px}
.report-loading__spinner{width:36px;height:36px;border:3px solid #e8e8e8;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.report-loading__text{font-family:var(--font-d);font-size:20px;font-weight:700;color:var(--text);margin-bottom:6px}
.report-loading__sub{font-size:14px;color:var(--muted)}
.report-stream{font-size:15.5px;line-height:1.75;color:var(--text2);animation:fadeIn .3s ease}
.report-stream h2{font-family:var(--font-d);font-size:22px;font-weight:700;color:var(--text);margin:32px 0 12px;letter-spacing:-.3px}
.report-stream h3{font-family:var(--font-d);font-size:18px;font-weight:700;color:var(--text);margin:24px 0 8px}
.report-stream p{margin-bottom:14px}
.report-stream ul{margin:12px 0 16px;padding-left:22px}
.report-stream li{margin-bottom:6px}
.report-stream strong{color:var(--text);font-weight:600}
.report-stream code{background:#f0f0f0;padding:2px 6px;border-radius:4px;font-size:13px}

.out__act{text-align:center;margin-top:40px;padding-top:28px;border-top:1.5px solid var(--border)}
.btn-restart{padding:12px 32px;border-radius:var(--r);border:1.5px solid var(--border);background:var(--surface);color:var(--text2);font-size:14px;font-weight:600;cursor:pointer;font-family:var(--font-b);transition:all .2s ease}
.btn-restart:hover{border-color:var(--border-hov);color:var(--text)}
</style>
</head>
<body>

<header class="hdr wrap">
  <div class="hdr__brand">
    <span class="hdr__logo">EndoTool</span>
    <span class="hdr__badge">Evidence-Based</span>
  </div>
  <p class="hdr__tag">Understand your endometriosis. Prepare for your appointment. Know your options.</p>
</header>

<div class="prog wrap">
  <div class="prog__bar" id="progbar"></div>
  <div class="prog__lbl">
    <span class="prog__n" id="pn"></span>
    <span class="prog__name" id="pname"></span>
  </div>
</div>

<main class="main wrap" id="main"></main>

<nav class="nav wrap" id="nav">
  <button class="nbtn nb-back" id="btnB" style="visibility:hidden">‚Üê Back</button>
  <button class="nbtn nb-next" id="btnN" disabled>Continue ‚Üí</button>
</nav>

<section class="out wrap" id="out" style="display:none"></section>

<script>
// ============ CITATION HELPERS ============
function C(code,tip){return `<span class="cite" data-tip="${tip}">${code}</span>`}
function EV(l){const c={Strong:'strong',High:'high',Moderate:'mod',Low:'low',Conditional:'mod'};return `<span class="ev ev--${c[l]||'mod'}">${l}</span>`}
const R=n=>C(`RANZCOG R-${n}`,'RANZCOG Australian Living Evidence Guideline 2025');
const Es=n=>C(`ESHRE E-${n}`,'ESHRE Guideline: Endometriosis 2022');
const N=r=>C(`NICE ${r}`,'NICE NG73: Endometriosis 2024');
const EAU=C('EAU-CPP','EAU Guidelines on Chronic Pelvic Pain 2025');
const SOGC=C('SOGC','SOGC No.445: Chronic Pelvic Pain 2024');
const IRE=C('Irish','Irish NCPG: Endometriosis 2025');
const JH=C('Jean Hailes','Jean Hailes GP Consult Guide 2025');

const SCREENS=["About You","Your Symptoms","Investigations","Treatments Tried","Fertility & Goals"];
const AGE_LABELS=["Under 18","18‚Äì24","25‚Äì34","35‚Äì39","40+"];
const AGE_IDS=["under18","18-24","25-34","35-39","40+"];

// ============ SYMPTOM CARD DATA ============
const SYM_CARDS=[
  {id:'pain',icon:'üî•',bg:'#fef2ef',title:'Pain',sub:'Period pain, pelvic pain, pain with sex or bowel movements',items:[
    {id:'dysmenorrhoea',label:'Painful periods severe enough to affect daily life'},
    {id:'pelvic-pain',label:'Pelvic pain outside of your period'},
    {id:'dyspareunia',label:'Pain during or after sex'},
    {id:'dyschezia',label:'Pain with bowel movements'},
    {id:'dysuria',label:'Pain when urinating'},
    {id:'back-pain',label:'Back pain related to your cycle'},
    {id:'refractory-pain',label:'Pain that hasn\'t responded to standard painkillers'},
  ]},
  {id:'bleeding',icon:'üíß',bg:'#fef0f5',title:'Bleeding',sub:'Changes to your period pattern or flow',items:[
    {id:'heavy-bleeding',label:'Heavy menstrual bleeding'},
    {id:'irregular-bleeding',label:'Irregular bleeding'},
  ]},
  {id:'bowel',icon:'ü´ß',bg:'#f0f4fe',title:'Bowel & Bladder',sub:'Digestive or urinary symptoms linked to your cycle',items:[
    {id:'cyclical-bowel',label:'Constipation or diarrhoea that worsens around your period'},
    {id:'bloating',label:'Bloating'},
    {id:'urinary-freq',label:'Urinary frequency or urgency'},
    {id:'haematuria',label:'Blood in urine around your period'},
    {id:'rectal-bleeding',label:'Blood in stool around your period'},
  ]},
  {id:'general',icon:'üåô',bg:'#f5f0fe',title:'Energy & Mood',sub:'Fatigue, sleep, headaches, emotional wellbeing',items:[
    {id:'fatigue',label:'Severe fatigue or tiredness'},
    {id:'sleep',label:'Sleep difficulties'},
    {id:'headache',label:'Headaches'},
    {id:'mood',label:'Low mood or anxiety related to your condition'},
  ]},
  {id:'impact',icon:'üíº',bg:'#fef8ef',title:'Life Impact',sub:'How symptoms affect your daily life',items:[
    {id:'missing-work',label:'Missing work or school'},
    {id:'avoiding-activity',label:'Avoiding physical activity'},
    {id:'relationship',label:'Impact on your relationship or intimacy'},
    {id:'mental-health',label:'Impact on your mental health'},
  ]},
  {id:'risk',icon:'üß¨',bg:'#edf5f1',title:'Risk Factors',sub:'Family history and other indicators',items:[
    {id:'family-hx',label:'First-degree relative with endometriosis'},
    {id:'autoimmune',label:'History of autoimmune disease'},
    {id:'early-menarche',label:'Periods started before age 11'},
    {id:'short-cycles',label:'Menstrual cycles shorter than 27 days'},
  ]},
  {id:'redflag',icon:'‚ö†Ô∏è',bg:'#fef2ef',title:'Red Flags',sub:'Symptoms that need urgent specialist attention',alert:true,items:[
    {id:'cyclical-rectal',label:'Rectal bleeding that comes and goes with your cycle'},
    {id:'cyclical-haematuria',label:'Blood in urine that comes and goes with your cycle'},
    {id:'shoulder-chest',label:'Cyclical shoulder tip pain or chest pain'},
  ]},
];

// ============ STATE ============
const S={
  screen:0,ageIdx:2,diagnosis:null,
  symptoms:{},// id->true
  openCards:{},
  investigations:[],usResult:null,
  painRelief:[],
  hormonal:{coc:{tried:false,outcome:null},pop:{tried:false,outcome:null},mirena:{tried:false,outcome:null},implant:{tried:false,outcome:null},depo:{tried:false,outcome:null},gnrha:{tried:false,outcome:null},gnrhant:{tried:false,outcome:null}},
  nonMedical:[],surgery:null,fertility:null,priorities:[]
};

// ============ DOM ============
const $=id=>document.getElementById(id);
const mainEl=$('main'),outEl=$('out'),navEl=$('nav'),btnB=$('btnB'),btnN=$('btnN');

// ============ RENDER HELPERS ============
const chkSvg='<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2.5 6L5 8.5L9.5 3.5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';

function radio(item,grp,sel){return `<label class="opt ${sel===item.id?'on':''}" data-g="${grp}" data-id="${item.id}"><input type="radio" name="${grp}"><span class="opt__rad"><span class="opt__dot"></span></span><span>${item.label}</span></label>`}
function checkbox(item,grp,arr){const on=arr.includes(item.id);return `<label class="opt ${on?'on':''}" data-g="${grp}" data-id="${item.id}"><input type="checkbox"><span class="opt__chk">${chkSvg}</span><span>${item.label}</span></label>`}
function fg(label,hint,content){return `<div class="fg"><div class="fg__lbl">${label}</div>${hint?`<div class="fg__hint">${hint}</div>`:''}<div class="fg__opts">${content}</div></div>`}

// ============ SCREEN RENDERERS ============
function renderScreen(dir){
  const cls=dir==='f'?'anim-f':dir==='b'?'anim-b':'anim-fade';
  const fns=[scr0,scr1,scr2,scr3,scr4,scr5];
  mainEl.innerHTML=fns[S.screen]();
  mainEl.className=`main wrap ${cls}`;
  window.scrollTo({top:0,behavior:'smooth'});
  updateNav();updateProg();attachEvents();
}

// SCREEN 0: About You ‚Äî Age caliper + Diagnosis
function scr0(){
  const pct=(S.ageIdx/(AGE_LABELS.length-1))*100;
  return `
    <h2 class="stitle">About You</h2>
    <p class="shint">Let's start with the basics so we can personalise your guide.</p>
    <div class="age-slider" id="ageslider">
      <div class="age-slider__label">Your age</div>
      <div class="age-slider__track-wrap">
        <div class="age-slider__track">
          <div class="age-slider__fill" style="width:${pct}%"></div>
          <div class="age-slider__thumb" style="left:${pct}%" id="agethumb">
            <div class="age-slider__value">${AGE_LABELS[S.ageIdx]}</div>
          </div>
        </div>
      </div>
      <div class="age-slider__ticks">
        ${AGE_LABELS.map((l,i)=>`<span class="age-slider__tick ${i===S.ageIdx?'on':''}" data-i="${i}">${l}</span>`).join('')}
      </div>
    </div>
    ${fg('Have you been diagnosed with endometriosis?',null,[
      {id:'suspected',label:'No ‚Äî I suspect I might have it'},
      {id:'us-confirmed',label:'Yes ‚Äî confirmed by ultrasound'},
      {id:'lap-confirmed',label:'Yes ‚Äî confirmed by laparoscopy / surgery'},
      {id:'adenomyosis',label:'Adenomyosis (or both)'},
    ].map(d=>radio(d,'diagnosis',S.diagnosis)).join(''))}`;
}

// SCREEN 1: Symptoms ‚Äî Visual cards
function scr1(){
  let html=`<h2 class="stitle">Your Symptoms</h2>
    <p class="shint">Tap each area to expand. Select everything that applies ‚Äî this builds the full picture.</p>
    <div class="sym-grid">`;

  for(const card of SYM_CARDS){
    const selCount=card.items.filter(i=>S.symptoms[i.id]).length;
    const isOpen=S.openCards[card.id];
    const hasSel=selCount>0;
    const isAlert=card.alert;
    html+=`<div class="sym-card ${isOpen?'open':''} ${hasSel?'has-sel':''} ${isAlert?'sym-card--alert':''}" data-card="${card.id}">
      <div class="sym-card__head" data-toggle="${card.id}">
        <div class="sym-card__icon" style="background:${card.bg}">${card.icon}</div>
        <div class="sym-card__info">
          <div class="sym-card__title">${card.title}</div>
          <div class="sym-card__sub">${card.sub}</div>
        </div>
        ${selCount?`<span class="sym-card__count">${selCount}</span>`:''}
        <span class="sym-card__arrow">‚ñæ</span>
      </div>
      <div class="sym-card__body">
        <div class="sym-card__inner">
          ${card.items.map(item=>{
            const on=S.symptoms[item.id];
            return `<div class="schip ${on?'on':''}" data-sym="${item.id}">
              <input type="checkbox" ${on?'checked':''}>
              <span class="schip__box">${chkSvg}</span>
              <span>${item.label}</span>
            </div>`;
          }).join('')}
        </div>
      </div>
    </div>`;
  }
  html+=`</div>`;

  // Red flag alert
  const redFlags=SYM_CARDS.find(c=>c.id==='redflag').items.filter(i=>S.symptoms[i.id]);
  if(redFlags.length>0){
    html+=`<div class="alert"><span class="alert__icon">‚ö†Ô∏è</span><div class="alert__text">The symptoms you've ticked may indicate deep endometriosis involving the bowel, bladder, or diaphragm. This will be flagged in your results ‚Äî specialist assessment is recommended.</div></div>`;
  }
  return html;
}

// SCREEN 2: Investigations
function scr2(){
  const invs=[
    {id:'none',label:'None ‚Äî I haven\'t had any tests yet'},
    {id:'exam',label:'Physical / pelvic examination'},
    {id:'tvus',label:'Pelvic ultrasound ‚Äî transvaginal (internal)'},
    {id:'taus',label:'Pelvic ultrasound ‚Äî transabdominal (on your tummy)'},
    {id:'amh',label:'Blood test for AMH (ovarian reserve)'},
    {id:'mri',label:'Pelvic MRI'},
    {id:'laparoscopy',label:'Laparoscopy (keyhole surgery)'},
  ];
  const hasUS=S.investigations.includes('tvus')||S.investigations.includes('taus');
  const usQ=hasUS?`<div class="sub-q">${fg('What were you told about the ultrasound results?',null,[
    {id:'normal',label:'Normal / nothing found'},
    {id:'endometrioma',label:'Cyst on ovary (endometrioma)'},
    {id:'die',label:'Signs of deep endometriosis'},
    {id:'unsure',label:'Not sure / wasn\'t told clearly'},
  ].map(r=>radio(r,'usResult',S.usResult)).join(''))}</div>`:'';

  return `<h2 class="stitle">Investigations</h2>
    <p class="shint">What tests have you had so far? It's completely fine if the answer is none.</p>
    ${fg('Select all that apply',null,invs.map(i=>checkbox(i,'investigations',S.investigations)).join(''))}
    ${usQ}`;
}

// SCREEN 3: Treatments
function scr3(){
  const painOpts=[
    {id:'paracetamol',label:'Paracetamol'},
    {id:'nsaids',label:'Anti-inflammatories (ibuprofen, naproxen)'},
    {id:'prescription',label:'Prescription painkillers (codeine, tramadol)'},
  ];
  const horms=[
    {id:'coc',label:'Combined pill (the Pill)'},
    {id:'pop',label:'Progestogen-only pill (mini pill)'},
    {id:'mirena',label:'Mirena IUD'},
    {id:'implant',label:'Contraceptive implant (Implanon)'},
    {id:'depo',label:'Depo-Provera injection'},
    {id:'gnrha',label:'GnRH agonist (e.g., Zoladex)'},
    {id:'gnrhant',label:'GnRH antagonist (e.g., Orilissa)'},
  ];
  const outcomes=["Helped","Didn't help","Side effects","Currently on"];
  const nonMed=[
    {id:'physio',label:'Pelvic floor physiotherapy'},
    {id:'psychology',label:'Psychology or counselling'},
    {id:'acupuncture',label:'Acupuncture'},
    {id:'exercise',label:'Regular exercise program'},
    {id:'diet',label:'Dietary changes (anti-inflammatory, FODMAP)'},
    {id:'supplements',label:'Supplements (omega-3, curcumin)'},
    {id:'mindfulness',label:'Mindfulness or meditation'},
  ];
  const surgOpts=[
    {id:'none',label:'No surgery'},
    {id:'one-lap',label:'One laparoscopy'},
    {id:'multiple',label:'More than one surgery'},
    {id:'recurrence',label:'Surgery ‚Äî endometriosis came back'},
    {id:'endometrioma-removed',label:'Endometrioma removed from ovary'},
  ];

  let hormHtml='';
  for(const h of horms){
    const d=S.hormonal[h.id];
    const on=d.tried;
    hormHtml+=`<label class="opt ${on?'on':''}" data-g="hormonal" data-id="${h.id}"><input type="checkbox"><span class="opt__chk">${chkSvg}</span><span>${h.label}</span></label>`;
    if(on){
      hormHtml+=`<div class="opills">${outcomes.map(o=>`<button class="opill ${d.outcome===o?'on':''}" data-g="hormonal" data-id="${h.id}" data-oc="${o}">${o}</button>`).join('')}</div>`;
    }
  }

  return `<h2 class="stitle">Treatments Tried</h2>
    ${fg('Pain relief',null,painOpts.map(p=>checkbox(p,'painRelief',S.painRelief)).join(''))}
    ${fg('Hormonal treatments','Tick any you\'ve tried, then select how it went.',hormHtml)}
    ${fg('Non-medical treatments',null,nonMed.map(n=>checkbox(n,'nonMedical',S.nonMedical)).join(''))}
    ${fg('Surgery',null,surgOpts.map(s=>radio(s,'surgery',S.surgery)).join(''))}`;
}

// SCREEN 4: Fertility & Goals
function scr4(){
  const over35=S.ageIdx>=3;
  const ferts=over35?[
    {id:'trying-now',label:'Actively trying to get pregnant now'},
    {id:'1-2-years',label:'Want children in the next 1‚Äì2 years'},
    {id:'3-5-years',label:'Want children in the next 3‚Äì5 years'},
    {id:'unsure',label:'Not sure about fertility plans'},
    {id:'no-goal',label:'Having children is not a goal for me'},
    {id:'completed',label:'I\'ve completed my family'},
  ]:[
    {id:'trying-now',label:'Actively trying to get pregnant now'},
    {id:'future',label:'I\'d like to have children in the future'},
    {id:'unsure',label:'Not sure about fertility plans'},
    {id:'no-goal',label:'Having children is not a goal for me'},
    {id:'completed',label:'I\'ve completed my family'},
  ];
  const prios=[
    {id:'reduce-pain',label:'Reducing my pain'},
    {id:'understand',label:'Understanding my condition better'},
    {id:'protect-fertility',label:'Protecting my future fertility'},
    {id:'get-pregnant',label:'Getting pregnant'},
    {id:'improve-qol',label:'Improving my quality of life'},
    {id:'get-diagnosis',label:'Getting a diagnosis'},
    {id:'prepare-specialist',label:'Preparing for a specialist appointment'},
    {id:'understand-surgery',label:'Understanding surgical options'},
    {id:'non-medical',label:'Finding non-medical management'},
  ];
  return `<h2 class="stitle">Fertility & Goals</h2>
    ${fg('Your fertility situation',null,ferts.map(f=>radio(f,'fertility',S.fertility)).join(''))}
    ${fg('What matters most right now?','Tick ALL that apply ‚Äî this shapes every section of your report.',prios.map(p=>checkbox(p,'priorities',S.priorities)).join(''))}`;
}

// SCREEN 5: Review
function scr5(){
  const age=AGE_LABELS[S.ageIdx];
  const dLbl={suspected:'Suspected','us-confirmed':'Ultrasound-confirmed','lap-confirmed':'Laparoscopy-confirmed',adenomyosis:'Adenomyosis'}[S.diagnosis]||'';
  const symN=Object.keys(S.symptoms).filter(k=>S.symptoms[k]).length;
  const hTried=Object.values(S.hormonal).filter(h=>h.tried).length;
  const hFail=Object.values(S.hormonal).filter(h=>h.tried&&(h.outcome==="Didn't help"||h.outcome==="Side effects")).length;
  const sLbl={none:'None','one-lap':'One laparoscopy',multiple:'Multiple surgeries',recurrence:'Surgery with recurrence','endometrioma-removed':'Endometrioma removed'}[S.surgery]||'';
  const fLbl={'trying-now':'Trying to conceive',future:'Future fertility','1-2-years':'Children in 1‚Äì2 years','3-5-years':'Children in 3‚Äì5 years',unsure:'Unsure','no-goal':'Not a goal',completed:'Family completed'}[S.fertility]||'';
  const redFlags=SYM_CARDS.find(c=>c.id==='redflag').items.filter(i=>S.symptoms[i.id]);
  const fertConcerned=['trying-now','future','1-2-years','3-5-years','unsure'].includes(S.fertility);

  return `<h2 class="stitle">Review & Generate</h2>
    <div class="scard">
      <div class="scard__t">Your Profile</div>
      <p><strong>Age:</strong> ${age} ¬∑ <strong>Diagnosis:</strong> ${dLbl}</p>
      <p><strong>Symptoms:</strong> ${symN} reported${S.symptoms['missing-work']||S.symptoms['avoiding-activity']||S.symptoms['relationship']||S.symptoms['mental-health']?' ¬∑ Life impact noted':''}</p>
      ${redFlags.length?`<div class="scard__rf">‚ö†Ô∏è Red flag symptoms ‚Äî urgent specialist referral recommended</div>`:''}
      <p><strong>Investigations:</strong> ${S.investigations.includes('none')?'None yet':S.investigations.join(', ')||'None selected'}${S.usResult?` ‚Üí ${S.usResult}`:''}</p>
      <p><strong>Treatments:</strong> ${hTried?`${hTried} hormonal`:'No hormonal'}${hFail?` (${hFail} failed)`:''} ¬∑ ${S.painRelief.length} pain relief ¬∑ ${S.nonMedical.length} non-medical</p>
      <p><strong>Surgery:</strong> ${sLbl} ¬∑ <strong>Fertility:</strong> ${fLbl}</p>
    </div>
    ${fertConcerned?`<div class="ftcard"><div class="ftcard__hdr"><span style="font-size:18px">üîó</span><span class="ftcard__t">Fertool Assessment Included</span></div><div class="ftcard__txt">Your report will include a <strong>personalised Fertool fertility assessment</strong> with actionable next steps based on your age, diagnosis, and fertility goals.</div></div>`:''}
    <div class="gen-area">
      <p class="gen-area__hint">Your report covers 8 evidence-based sections plus a personalised fertility assessment.</p>
      <button class="btn-gen" id="btnGen">Generate My Report</button>
      <p class="gen-area__disc">Evidence-based information to prepare you for your appointment. Does not replace medical advice.</p>
    </div>`;
}

// ============ NAVIGATION ============
function canProceed(){
  switch(S.screen){
    case 0:return S.diagnosis!==null;
    case 1:return true;
    case 2:return true;
    case 3:return S.surgery!==null;
    case 4:return S.fertility!==null;
    default:return true;
  }
}
function updateNav(){
  btnB.style.visibility=S.screen>0?'visible':'hidden';
  if(S.screen===5){btnN.style.display='none'}
  else{btnN.style.display='';btnN.disabled=!canProceed();btnN.textContent=S.screen===4?'Review ‚Üí':'Continue ‚Üí'}
}
function updateProg(){
  const bar=$('progbar');
  bar.innerHTML=SCREENS.map((_,i)=>`<div class="prog__seg ${i<=Math.min(S.screen,4)?'on':''}"></div>`).join('');
  $('pn').textContent=S.screen<=4?`Step ${S.screen+1} of 5`:'Review';
  $('pname').textContent=S.screen<=4?SCREENS[S.screen]:'Summary';
}
function nav(dir){
  if(dir==='f'&&!canProceed())return;
  S.screen+=dir==='f'?1:-1;
  renderScreen(dir);
}
btnN.addEventListener('click',()=>nav('f'));
btnB.addEventListener('click',()=>nav('b'));

// ============ EVENTS ============
function attachEvents(){
  // Age slider
  const slider=$('ageslider');
  if(slider){
    const track=slider.querySelector('.age-slider__track');
    const thumb=$('agethumb');
    let dragging=false;
    function setAge(clientX){
      const rect=track.getBoundingClientRect();
      let pct=(clientX-rect.left)/rect.width;
      pct=Math.max(0,Math.min(1,pct));
      const idx=Math.round(pct*(AGE_LABELS.length-1));
      S.ageIdx=idx;
      renderScreen(null);
    }
    if(thumb){
      thumb.addEventListener('mousedown',e=>{dragging=true;e.preventDefault()});
      thumb.addEventListener('touchstart',e=>{dragging=true});
      document.addEventListener('mousemove',e=>{if(dragging)setAge(e.clientX)});
      document.addEventListener('touchmove',e=>{if(dragging)setAge(e.touches[0].clientX)});
      document.addEventListener('mouseup',()=>dragging=false);
      document.addEventListener('touchend',()=>dragging=false);
    }
    track.addEventListener('click',e=>setAge(e.clientX));
    slider.querySelectorAll('.age-slider__tick').forEach(t=>{
      t.addEventListener('click',()=>{S.ageIdx=parseInt(t.dataset.i);renderScreen(null)});
    });
  }

  // Generate button
  const genBtn=$('btnGen');
  if(genBtn)genBtn.addEventListener('click',generateReport);
}

// Main event delegation
mainEl.addEventListener('click',function(e){
  // Symptom card toggle
  const toggle=e.target.closest('[data-toggle]');
  if(toggle){S.openCards[toggle.dataset.toggle]=!S.openCards[toggle.dataset.toggle];renderScreen(null);return}
  // Symptom chip
  const sym=e.target.closest('[data-sym]');
  if(sym){S.symptoms[sym.dataset.sym]=!S.symptoms[sym.dataset.sym];renderScreen(null);return}
  // Radio
  const optR=e.target.closest('.opt[data-g]');
  if(optR&&optR.querySelector('input[type=radio]')){S[optR.dataset.g]=optR.dataset.id;renderScreen(null);return}
  // Checkbox
  const optC=e.target.closest('.opt[data-g]');
  if(optC&&optC.querySelector('input[type=checkbox]')){
    const g=optC.dataset.g,id=optC.dataset.id;
    if(g==='hormonal'){S.hormonal[id].tried=!S.hormonal[id].tried;if(!S.hormonal[id].tried)S.hormonal[id].outcome=null}
    else if(g==='investigations'){if(id==='none'){S.investigations=S.investigations.includes('none')?[]:['none']}else{S.investigations=S.investigations.filter(v=>v!=='none');const idx=S.investigations.indexOf(id);if(idx>=0)S.investigations.splice(idx,1);else S.investigations.push(id)}}
    else{const arr=S[g];if(arr){const idx=arr.indexOf(id);if(idx>=0)arr.splice(idx,1);else arr.push(id)}}
    renderScreen(null);return;
  }
  // Outcome pill
  const pill=e.target.closest('.opill');
  if(pill){S.hormonal[pill.dataset.id].outcome=pill.dataset.oc;renderScreen(null);return}
});

// ============ OUTPUT GENERATION ============
const FERTOOL_API='https://fertility-gp-backend-532857641879.australia-southeast2.run.app';

function generateReport(){
  document.querySelector('.hdr').style.display='none';
  document.querySelector('.prog').style.display='none';
  mainEl.style.display='none';
  navEl.style.display='none';
  outEl.style.display='';

  const p=profile();
  const ftBlurb=buildFertoolBlurb(p);
  const rf=p.hasRF?'<div class="alert" style="margin-bottom:28px"><div class="alert__text"><strong>Some of your symptoms may indicate deep endometriosis involving the bowel, bladder, or diaphragm.</strong> Urgent specialist referral is recommended.</div></div>':'';
  const profilePrompt=buildProfilePrompt(p);

  const ftBox=`<div class="fertool-box">
    <div class="fertool-box__badge">Guidelines</div>
    <h2 class="fertool-box__title">How can I help?</h2>
    <div class="fertool-box__wrap">
      <input class="fertool-box__input" id="ftSearchInput" type="text" placeholder="Ask about AMH, referral criteria, initial investigations...">
      <button class="fertool-box__btn" id="ftSearchBtn">Search</button>
    </div>
    <div class="fertool-box__chips" id="ftChips"></div>
    <div class="fertool-box__loading" id="ftLoading">Searching guidelines...</div>
    <div class="fertool-box__response" id="ftResponse">
      <div class="fertool-box__response-label">Response</div>
      <div class="fertool-box__response-a" id="ftResponseA"></div>
      <div class="fertool-box__response-src" id="ftResponseSrc"></div>
    </div>
    <input type="hidden" id="ftProfileContext" value="${profilePrompt.replace(/"/g,'&quot;')}">
  </div>`;

  outEl.innerHTML=`${ftBlurb}${ftBox}${rf}
    <div id="reportArea">
      <div id="reportLoading" class="report-loading">
        <div class="report-loading__spinner"></div>
        <div class="report-loading__text">Generating your personalised report...</div>
        <div class="report-loading__sub">Analysing your profile against clinical guidelines</div>
      </div>
    </div>`;
  outEl.className='out wrap anim-fade';
  window.scrollTo({top:0,behavior:'smooth'});
  initFertoolSearch();
  streamTailoredReport(p,profilePrompt);
}

function restart(){
  S.screen=0;S.diagnosis=null;S.symptoms={};S.openCards={};S.investigations=[];S.usResult=null;S.painRelief=[];
  Object.keys(S.hormonal).forEach(k=>S.hormonal[k]={tried:false,outcome:null});
  S.nonMedical=[];S.surgery=null;S.fertility=null;S.priorities=[];
  document.querySelector('.hdr').style.display='';document.querySelector('.prog').style.display='';
  mainEl.style.display='';navEl.style.display='';outEl.style.display='none';
  renderScreen('f');
}

function buildProfilePrompt(p){
  const symNames=p.syms.map(id=>{
    for(const c of SYM_CARDS){const item=c.items.find(i=>i.id===id);if(item)return item.label;}return id;
  });
  const hTriedNames=p.hTried.map(([k,v])=>k+(v.outcome?' ('+v.outcome+')':''));
  return `PATIENT PROFILE - GENERATE PERSONALISED ENDOMETRIOSIS REPORT:

Age: ${AGE_LABELS[S.ageIdx]}
Diagnosis: ${S.diagnosis==='suspected'?'Suspected (not confirmed)':S.diagnosis==='us-confirmed'?'Confirmed by ultrasound':S.diagnosis==='lap-confirmed'?'Confirmed by laparoscopy':S.diagnosis==='adenomyosis'?'Adenomyosis (or both)':'Unknown'}
Symptoms: ${symNames.join(', ')||'None specified'}
Red flags: ${p.hasRF?SYM_CARDS.find(c=>c.id==='redflag').items.filter(i=>S.symptoms[i.id]).map(i=>i.label).join(', '):'None'}
Investigations: ${S.investigations.filter(i=>i!=='none').join(', ')||'None done'}
Ultrasound result: ${S.usResult==='normal'?'Normal':S.usResult==='endometrioma'?'Endometrioma found':S.usResult==='die'?'Deep endo signs':S.usResult==='unsure'?'Not told clearly':'Not done'}
Hormonal treatments: ${hTriedNames.length?hTriedNames.join(', '):'None tried'}
Non-medical tried: ${S.nonMedical.length?S.nonMedical.join(', '):'None'}
Surgery: ${S.surgery==='none'?'No surgery':S.surgery==='one-lap'?'One laparoscopy':S.surgery==='multiple'?'Multiple surgeries':S.surgery==='recurrence'?'Recurrence after surgery':S.surgery==='endometrioma-removed'?'Endometrioma removed':'None'}
Fertility goal: ${S.fertility==='trying-now'?'ACTIVELY TRYING TO CONCEIVE':S.fertility==='1-2-years'?'Wants children in 1-2 years':S.fertility==='3-5-years'?'Wants children in 3-5 years':S.fertility==='future'?'Future fertility':S.fertility==='unsure'?'Unsure about fertility':S.fertility==='no-goal'?'No fertility goal':'Family complete'}

Write a personalised evidence-based report for THIS patient. Rules:
- Address HER specific situation, not generic endometriosis info
- Lead with what matters most (fertility if TTC, pain if that is priority)
- Only include sections relevant to her profile
- Reference guidelines naturally (RANZCOG, ESHRE, NICE)
- Speak directly to her, warmly and clearly
- Acknowledge what she has already been through
- Do not repeat treatments she has already tried
- End with 3 specific next steps with timeline
- Keep it focused, quality over quantity
- Australian healthcare context (Medicare, GP referrals)`;
}

async function streamTailoredReport(p,prompt){
  const reportArea=document.getElementById('reportArea');
  const loadingEl=document.getElementById('reportLoading');

  try{
    // Use non-streaming /query (same endpoint as search box ‚Äî proven to work)
    const controller=new AbortController();
    const timeout=setTimeout(()=>controller.abort(),45000); // 45s for cold starts

    const res=await fetch(FERTOOL_API+'/query',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({question:prompt}),
      signal:controller.signal
    });
    clearTimeout(timeout);

    if(!res.ok)throw new Error('API '+res.status);
    const data=await res.json();
    const text=data.response||data.answer||data.result||'';
    if(!text.trim())throw new Error('Empty response');

    loadingEl.style.display='none';
    const contentEl=document.createElement('div');
    contentEl.className='report-stream';
    contentEl.innerHTML=fmtMd(text)+SOURCE_LEGEND;
    reportArea.appendChild(contentEl);

  }catch(err){
    console.log('Fertool report failed:',err.message);
    loadingEl.style.display='none';

    // Smart fallback: filtered + reordered sections based on profile
    const sections=buildSmartFallback(p);
    reportArea.innerHTML=`<div class="out__hdr"><h1 class="out__t">Your Evidence-Based Guide</h1><p class="out__sub">Tailored to your profile ‚Äî drawn from international clinical guidelines.</p></div>${sections}${SOURCE_LEGEND}`;
  }

  const rb=document.createElement('div');
  rb.style.cssText='text-align:center;margin:32px 0';
  rb.innerHTML='<button id="btnRestart" class="btn-restart" style="cursor:pointer">Start Again</button>';
  reportArea.appendChild(rb);
  document.getElementById('btnRestart')?.addEventListener('click',restart);
}

// Smart fallback: only show relevant sections, in priority order
function buildSmartFallback(p){
  const ordered=[];
  let n=1;

  // 1. LEAD WITH WHAT MATTERS MOST
  if(p.tryNow){
    // TTC: fertility first
    ordered.push(rsec(n++,'Fertility & Trying to Conceive',buildFertSec(p)));
    if(p.endo||p.die)ordered.push(rsec(n++,'Surgery Decisions',buildSurgSec(p)));
    ordered.push(rsec(n++,'Pain Management While Trying',buildPainTTCSec(p)));
    ordered.push(rsec(n++,'Investigations',buildInvSec(p)));
  }else if(p.futFert){
    // Future fertility: fertility preservation + disease management
    ordered.push(rsec(n++,'Your Fertility',buildFertSec(p)));
    ordered.push(rsec(n++,'Medical Treatment',buildMedSec(p)));
    if(p.endo||p.die||p.hadSurg)ordered.push(rsec(n++,'Surgery Decisions',buildSurgSec(p)));
    if(p.syms.length>1)ordered.push(rsec(n++,'Pain Management',buildPainSec(p)));
    ordered.push(rsec(n++,'Investigations',buildInvSec(p)));
  }else{
    // No fertility goal: pain/treatment first
    if(p.syms.length>0)ordered.push(rsec(n++,'Understanding Your Symptoms',buildSym(p)));
    ordered.push(rsec(n++,'Medical Treatment',buildMedSec(p)));
    if(p.syms.length>1)ordered.push(rsec(n++,'Pain Management',buildPainSec(p)));
    ordered.push(rsec(n++,'Investigations',buildInvSec(p)));
    if(p.endo||p.die||p.hadSurg)ordered.push(rsec(n++,'Surgery Decisions',buildSurgSec(p)));
  }

  // Always end with next steps
  ordered.push(rsec(n++,'Your Next Steps',buildNextSec(p)));

  return ordered.join('');
}

// --- Filtered section builders ---

function buildSym(p){
  const ps=[];
  if(p.adol)ps.push(`<strong>Your pain is real and deserves investigation.</strong> Period pain that stops you going to school is NOT normal. ${R(75)} ${Es(74)}`);
  ps.push(`<strong>Pain severity does NOT match disease extent.</strong> Your pain is valid regardless of scan findings. ${R(21)} ${Es(9)}`);
  if(p.refPain)ps.push(`When pain persists, the nervous system changes ‚Äî pain centres become more sensitive. <strong>This is NOT "in your head"</strong> ‚Äî it's a real, measurable change. ${EAU} ${SOGC}`);
  if(p.cycBowel)ps.push(`Cyclical bowel or bladder symptoms can indicate <strong>deeper endometriosis</strong> ‚Äî important for your doctor. ${N('1.1.4')} ${Es(3)}`);
  if(p.dysp)ps.push(`Pain with intimacy is common with endo and there are practical strategies that help ‚Äî <strong>pelvic physio, communication, positioning.</strong> ${EAU}`);
  if(p.fatigue||p.sleep)ps.push(`Fatigue and sleep disruption commonly co-exist with endo. Mention this to your doctor ‚Äî it affects treatment planning. ${JH} ${EAU}`);
  if(!ps.length)ps.push(`Endometriosis is a chronic condition requiring long-term management ‚Äî but many evidence-based approaches can help. ${R(3)} ${Es(1)}`);
  return ps;
}

function buildInvSec(p){
  const ps=[];
  if(p.noInv)ps.push(`Your GP can arrange a <strong>transvaginal ultrasound</strong> ‚Äî first-line investigation. You can start treatment while waiting. ${R(14)} ${N('1.5.1')}`);
  else if(p.hasUS&&p.usNorm)ps.push(`A normal ultrasound doesn't rule out endo ‚Äî particularly superficial disease. Further investigation or specialist referral is appropriate if symptoms persist. ${R(16)} ${N('1.5.4')}`);
  if(p.endo)ps.push(`Your endometrioma confirms endometriosis. <strong>Specialist endometriosis service referral</strong> is recommended. ${N('1.5.6')}`);
  if(p.die)ps.push(`Deep endo on ultrasound ‚Üí <strong>MRI recommended</strong> to map extent for surgical planning. ${R(14)} ${N('1.5.9')}`);
  ps.push(`<strong>CA-125 blood test is NOT recommended</strong> for diagnosis. ${R(20)} ${Es(4)} ${N('1.5.8')}`);
  if(!p.endo&&!p.die)ps.push(`<strong>Laparoscopy</strong> can be considered even with normal imaging, if symptoms persist. ${Es(6)}`);
  return ps;
}

function buildMedSec(p){
  const ps=[];
  if(p.tryNow){
    ps.push(`While trying to conceive: <strong>anti-inflammatories only</strong> for pain. ${R(25)} ${SOGC}`);
    return ps;
  }
  ps.push(`All first-line hormonal treatments have <strong>similar effectiveness</strong>. Options: combined pill, progestogen-only pill, Mirena IUD, implant, Depo-Provera. ${Es(13)} ${Es(15)} ${Es(17)}`);
  ps.push(`Review after 3 months. If it doesn't suit you, try a different option before escalating. ${R(32)}`);
  if(p.futFert)ps.push(`<strong>Hormonal treatment will NOT harm future fertility.</strong> ${N('1.4.5')} ${R(65)}`);
  if(p.failMult)ps.push(`You've tried multiple treatments. Second-line options: <strong>GnRH agonists</strong> with add-back ${R(33)} ${Es(18)}, <strong>GnRH antagonists</strong> ${Es(21)}, or <strong>aromatase inhibitors</strong> for refractory pain. ${Es(23)}`);
  ps.push(`<strong>Anti-inflammatories</strong> effective for period pain. ${R(25)} <strong>Opioids NOT recommended</strong> long-term. ${SOGC}`);
  if(p.adeno)ps.push(`For adenomyosis: dienogest, oral contraceptives, Mirena, or implant ${R(36)}. Consider hormonal therapy before hysterectomy. ${R(39)}`);
  return ps;
}

function buildSurgSec(p){
  const ps=[];
  if(p.endo){
    ps.push(`Endometrioma: <strong>excision generally preferred</strong> (lower recurrence) ‚Äî but consider ovarian reserve impact. ${R(42)} ${Es(26)} ${Es(28)}`);
    if(p.tryNow||p.futFert)ps.push(`<strong>Surgery before IVF is NOT routinely recommended</strong> ‚Äî no benefit and may harm reserve. Exception: significant pain or blocked follicle access. ${Es(56)} ${Es(57)}`);
  }
  if(p.die||p.hasRF){
    ps.push(`DIE removal may reduce pain and improve quality of life ‚Äî requires <strong>specialist expertise</strong>. ${Es(29)} ${Es(30)}`);
    if(p.tryNow||p.futFert)ps.push(`DIE + fertility: <strong>no clear evidence surgery improves fertility.</strong> Decision guided by pain and preference. ${R(63)} ${Es(45)}`);
  }
  if(p.recur||S.surgery==='multiple')ps.push(`Repeat surgery: <strong>careful consideration</strong> ‚Äî diminishing returns, adhesion risk. ${R(45)}`);
  if(!p.tryNow)ps.push(`Post-surgical hormonal treatment (<strong>6‚Äì12 months minimum</strong>) reduces recurrence. ${R(67)} ${Es(65)}`);
  return ps;
}

function buildFertSec(p){
  const ps=[`Endometriosis is associated with difficulty conceiving, but <strong>many women conceive naturally</strong>. ${R(61)}`];
  if(p.tryNow){
    ps.push(`<strong>Hormonal treatments don't improve pregnancy chances</strong> and should be paused while trying. ${Es(39)} ${R(64)}`);
    ps.push(`Referral to a <strong>fertility specialist</strong> is recommended. ${R(61)}`);
    if(p.over35||p.is40)ps.push(`At your age, <strong>timing is important.</strong> Earlier specialist engagement means more options. ${Es(59)}`);
    if(p.endo)ps.push(`Your endometrioma means both the disease AND any surgery can affect egg supply ‚Äî a fertility specialist can advise on the best sequence. ${Es(85)}`);
  }else{
    ps.push(`<strong>Hormonal treatment is safe and does NOT harm future fertility.</strong> ${N('1.4.5')} ${R(65)}`);
    if(p.endo)ps.push(`Both the disease AND surgery can affect egg supply ‚Äî <strong>discuss timing with your specialist.</strong> ${Es(85)}`);
    if(p.over35)ps.push(`<strong>Over 35: timing matters more.</strong> Ovarian reserve declines steeply. Earlier specialist engagement recommended. ${Es(59)}`);
    ps.push(`<strong>Fertility preservation (egg freezing)</strong> may be worth discussing, especially with ovarian endo or planned surgery. ${Es(59)}`);
  }
  return ps;
}

function buildPainTTCSec(p){
  const ps=[
    `While trying to conceive, pain management is limited to <strong>non-hormonal options</strong>. ${R(64)}`,
    `<strong>Anti-inflammatories</strong> (like ibuprofen) are reasonable for period pain ‚Äî check timing with your doctor. ${R(25)} ${SOGC}`,
    `<strong>Pelvic floor physiotherapy</strong> ‚Äî 64% pain reduction sustained at 1 year. Ask for a specialist women's health physio. ${EAU} ${R(12)}`,
  ];
  if(p.dysp)ps.push(`For pain during intimacy: pelvic physio, communication, positioning changes, lubricants. ${EAU}`);
  ps.push(`<strong>Heat therapy, gentle exercise</strong> ‚Äî simple but evidence-supported. ${SOGC}`);
  return ps;
}

function buildPainSec(p){
  const ps=[
    `<strong>Pelvic floor physiotherapy</strong> ‚Äî 64% pain reduction sustained at 1 year. Specialist physio (not general). ${EAU} ${R(12)}`,
    `<strong>CBT</strong> ‚Äî benefits comparable to medication for chronic pain. ${SOGC}`,
  ];
  if(p.dysp)ps.push(`For pain during intimacy: pelvic physio, communication, positioning, lubricants, couples counselling. ${EAU}`);
  if(p.fatigue||p.sleep)ps.push(`<strong>CBT for insomnia</strong> ‚Äî first-line for sleep difficulties, safer than long-term medication. ${SOGC}`);
  ps.push(`<strong>Acupuncture</strong> ‚Äî improvement sustained at 24 weeks. ${EAU}`);
  ps.push(`Your GP can set up a <strong>Chronic Disease Management Plan</strong> ‚Äî up to 5 Medicare-subsidised allied health visits/year. ${R(9)}`);
  return ps;
}

function buildNextSec(p){
  const gpQs=[];
  if(p.endo||p.die||p.hasRF)gpQs.push('"Can you refer me to a specialist endometriosis service?"');
  if(p.tryNow||p.futFert)gpQs.push('"Can I have an AMH test to check ovarian reserve?"');
  if(p.tryNow)gpQs.push('"Can you refer me to a fertility specialist?"');
  if(p.futFert&&(p.endo||p.over35))gpQs.push('"Should I consider fertility preservation?"');
  gpQs.push('"Can you set up a Chronic Disease Management Plan?"');
  if(p.syms.length>2)gpQs.push('"Can you refer me for pelvic floor physiotherapy?"');

  const ps=[`<strong>Questions for your GP:</strong><br>${gpQs.join('<br>')}`];
  if(p.die||p.hasRF)ps.push(`DIE involving bowel/bladder/ureter ‚Üí <strong>specialist endometriosis service.</strong> ${N('1.5.6')} ${R(11)}`);
  ps.push(`Support: <strong>Endometriosis Australia</strong>, Jean Hailes, Pelvic Pain Foundation of Australia, QENDO. Telehealth available. ${R(8)}`);
  return ps;
}

function fmtMd(t){
  return t
    .replace(/### (.*)/g,'<h3>$1</h3>')
    .replace(/## (.*)/g,'<h2>$1</h2>')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/^- (.*)/gm,'<li>$1</li>')
    .replace(/\n\n/g,'</p><p>')
    .replace(/\n/g,'<br>');
}


function profile(){
  const over35=S.ageIdx>=3,adol=S.ageIdx===0,is40=S.ageIdx===4;
  const syms=Object.keys(S.symptoms).filter(k=>S.symptoms[k]);
  const hTried=Object.entries(S.hormonal).filter(([,v])=>v.tried);
  const hFail=hTried.filter(([,v])=>v.outcome==="Didn't help"||v.outcome==="Side effects");
  const tryNow=S.fertility==='trying-now';
  const futFert=['future','1-2-years','3-5-years','unsure'].includes(S.fertility);
  const noFert=['no-goal','completed'].includes(S.fertility);
  const endo=S.usResult==='endometrioma'||S.diagnosis==='us-confirmed';
  const die=S.usResult==='die';
  const adeno=S.diagnosis==='adenomyosis';
  const noInv=S.investigations.includes('none')||S.investigations.length===0;
  const hasUS=S.investigations.includes('tvus')||S.investigations.includes('taus');
  const usNorm=S.usResult==='normal';
  const redFlags=SYM_CARDS.find(c=>c.id==='redflag').items.filter(i=>S.symptoms[i.id]);
  const hasRF=redFlags.length>0;
  const failMult=hFail.length>=2;
  const recur=S.surgery==='recurrence';
  const hadSurg=['one-lap','multiple','recurrence','endometrioma-removed'].includes(S.surgery);
  return{over35,adol,is40,syms,hTried,hFail,tryNow,futFert,noFert,endo,die,adeno,noInv,hasUS,usNorm,hasRF,failMult,recur,hadSurg,
    refPain:S.symptoms['refractory-pain'],dysp:S.symptoms['dyspareunia'],fatigue:S.symptoms['fatigue'],
    sleep:S.symptoms['sleep'],mood:S.symptoms['mood'],cycBowel:S.symptoms['cyclical-bowel'],
    famHx:S.symptoms['family-hx']||S.symptoms['family-hx'],relImpact:S.symptoms['relationship']};
}

function rsec(n,title,paras){return `<div class="rsec"><div class="rsec__n">Section ${n}</div><h3 class="rsec__t">${title}</h3><div class="rsec__c">${paras.map(p=>`<p>${p}</p>`).join('')}</div></div>`}

function sec1(p){
  const ps=[
    `Endometriosis affects approximately <strong>1 in 7</strong> Australian women ‚Äî you are not alone. ${R(1)}`,
    `The average diagnostic delay in Australia is <strong>6.5 years</strong>. If you've struggled without answers, that's unfortunately common. ${R(2)}`,
    `<strong>Pain severity does NOT match disease extent.</strong> Some people with minimal endo have severe pain, while others with extensive disease have few symptoms. Your pain is valid regardless of scan findings. ${R(21)} ${Es(9)}`,
    `Endometriosis is a chronic condition requiring long-term management ‚Äî but many evidence-based approaches can help. ${R(3)} ${Es(1)}`,
  ];
  if(p.adol)ps.push(`<strong>Your pain is real and deserves investigation.</strong> Period pain that stops you going to school is NOT normal. ${R(75)} ${Es(74)}`);
  if(S.symptoms['family-hx'])ps.push(`Having a first-degree relative with endometriosis is a recognised risk factor, adding weight to investigating your symptoms. ${JH}`);
  if(p.cycBowel)ps.push(`Cyclical bowel or bladder symptoms can indicate <strong>deeper endometriosis</strong> ‚Äî important information for your doctor. ${N('1.1.4')} ${Es(3)}`);
  if(p.refPain)ps.push(`When pain persists, the nervous system changes ‚Äî pain-processing centres become more sensitive, like turning up the volume. Pain can feel more intense than expected, spread, or persist after treatment. <strong>This is NOT "in your head"</strong> ‚Äî it's a real, measurable nervous system change. Treatment may need to address pain pathways, not just endo. ${EAU} ${SOGC}`);
  ps.push(`Endometriosis commonly co-exists with: <strong>migraine, IBS, bladder pain, chronic fatigue, low mood, pain during intimacy.</strong> Mention these to your doctor. ${JH} ${EAU}`);
  ps.push(`Understanding pain mechanisms is recognised as a key part of treatment ‚Äî which is what this tool helps with. ${EAU}`);
  return rsec(1,'Understanding Your Situation',ps);
}
function sec2(p){
  const ps=[
    `<strong>Transvaginal ultrasound (TVUS) is first-line</strong>, even if examination is normal. It can identify endometriomas, deep endo, and guide management. ${R(14)} ${Es(5)} ${N('1.5.2')}`,
  ];
  if(p.adol)ps.push(`When TVUS isn't suitable, <strong>transabdominal ultrasound</strong> is an option. MRI or transperineal US can be considered by a specialist. ${R(75)} ${Es(74)}`);
  ps.push(`<strong>A normal ultrasound does NOT rule out endometriosis</strong> ‚Äî particularly superficial disease. ${R(16)} ${N('1.5.4')}`);
  ps.push(`<strong>MRI is recommended</strong> if deep endometriosis is suspected, for surgical planning. ${R(14)} ${N('1.5.9')}`);
  ps.push(`<strong>CA-125 blood test is NOT recommended</strong> for diagnosis. ${R(20)} ${Es(4)} ${N('1.5.8')}`);
  ps.push(`<strong>Laparoscopy</strong> can be considered even with normal imaging, if symptoms persist. ${Es(6)}`);
  ps.push(`<strong>Investigations, referral, and treatment can happen simultaneously</strong> ‚Äî no need to wait. ${N('1.5.1')}`);
  if(p.noInv)ps.push(`Your GP can arrange an ultrasound. You can start treatment while waiting for results. ${N('1.5.1')} ${IRE}`);
  if(p.hasUS&&p.usNorm)ps.push(`A normal ultrasound doesn't rule out endo. If symptoms persist, further investigation or specialist referral is appropriate. ${R(16)}`);
  if(p.endo)ps.push(`An endometrioma confirms endometriosis. <strong>Referral to a specialist endometriosis service</strong> is recommended. ${N('1.5.6')}`);
  if(p.die)ps.push(`Signs of deep endo on ultrasound ‚Üí <strong>MRI recommended</strong> to map extent for surgical planning. ${R(14)} ${N('1.5.9')}`);
  return rsec(2,'Investigations',ps);
}
function sec3(p){
  const ps=[];
  if(p.tryNow){
    ps.push(`<div class="blocked"><div class="blocked__t"><strong>Because you're actively trying to conceive, hormonal treatment is NOT recommended</strong> ‚Äî it doesn't improve pregnancy chances. Do NOT get pregnant solely to treat endo. ${R(64)} ${Es(39)} ${Es(60)} ${N('1.10.4')}</div></div>`);
    ps.push(`A short trial of <strong>anti-inflammatories</strong> is reasonable for pain. ${R(25)} ${EV('Strong')} ${SOGC}`);
  }else{
    ps.push(`All first-line hormonal treatments have <strong>similar effectiveness</strong>. Options: <strong>combined pill</strong> ${Es(13)}, <strong>progestogen-only pill</strong> ${Es(15)}, <strong>Mirena IUD</strong> ${Es(17)}, <strong>implant</strong> ${Es(17)}, <strong>Depo-Provera</strong> ${Es(15)}.`);
    ps.push(`Review after 3 months. If it doesn't suit you, try a different first-line option before escalating. ${R(32)}`);
    ps.push(`<strong>Hormonal treatment will NOT harm future fertility.</strong> ${N('1.4.5')} ${R(65)}`);
    if(p.failMult)ps.push(`Second-line: <strong>GnRH agonists</strong> with add-back therapy ${R(33)} ${Es(18)}, <strong>GnRH antagonists</strong> ${Es(21)}, or <strong>aromatase inhibitors</strong> for refractory pain ${Es(23)}.`);
    ps.push(`<strong>Anti-inflammatories</strong> effective for period pain ${EV('Strong')} ${SOGC}, less clear for non-menstrual pain ${EV('Conditional')} ${SOGC}. ${R(25)}`);
    ps.push(`<strong>Opioids NOT recommended</strong> for long-term chronic pelvic pain. ${EV('Strong')} ${SOGC}`);
    if(p.refPain)ps.push(`<strong>Tricyclic antidepressants at low doses</strong> may help nerve-sensitised pain ‚Äî prescribed for pain pathways, not mood. ${EV('Strong')} ${SOGC}`);
  }
  if(p.adeno)ps.push(`For adenomyosis: dienogest, oral contraceptives, Mirena, or implant ${R(36)}. GnRH agonists second-line ${R(38)}. Consider hormonal therapy before hysterectomy. ${R(39)}`);
  return rsec(3,'Medical Treatment',ps);
}
function sec4(p){
  const ps=[`Surgery should be <strong>laparoscopic</strong> unless contraindicated. ${R(41)} Treatment guided by symptoms, <strong>NOT disease stage</strong>. ${R(21)} ${N('1.6.1')}`];
  if(p.endo){
    ps.push(`Endometrioma: <strong>excision generally preferred</strong> (lower recurrence) ${R(42)} ${Es(26)} ${IRE} ${EV('Moderate')} ‚Äî but consider ovarian reserve impact. ${Es(28)}`);
    if(p.tryNow||p.futFert)ps.push(`<strong>Surgery before IVF NOT routinely recommended</strong> ‚Äî no benefit, harms reserve. Exception: significant pain or blocked follicle access. ${Es(56)} ${Es(57)}`);
  }
  ps.push(`For superficial endo: excision vs ablation ‚Äî evidence doesn't clearly favour either. ${R(44)}`);
  if(p.tryNow||p.futFert)ps.push(`Surgery for superficial endo <strong>may improve natural pregnancy</strong>. ${Es(43)} ${N('1.10.1')}`);
  if(p.die||p.hasRF){
    ps.push(`DIE surgical removal may reduce pain and improve QoL ‚Äî requires <strong>specialist surgical expertise</strong>. ${Es(29)} ${Es(30)} ${N('1.5.6')}`);
    if(p.tryNow||p.futFert)ps.push(`DIE + fertility: <strong>no clear evidence surgery improves fertility</strong> ‚Äî decision guided by pain and preference. ${R(63)} ${Es(45)}`);
  }
  if(p.recur||S.surgery==='multiple')ps.push(`Repeat surgery: <strong>careful consideration</strong> ‚Äî diminishing returns, adhesion risk. ${R(45)}`);
  ps.push(`Post-surgical hormonal treatment (<strong>6‚Äì12 months minimum</strong>) reduces recurrence. ${R(67)} ${Es(65)}`);
  if(p.noFert&&(p.failMult||p.hadSurg))ps.push(`Hysterectomy (total preferred ${IRE}) can be considered if no fertility goal AND other treatments failed. <strong>Won't necessarily cure symptoms.</strong> ${R(50)} ${Es(32)} If ovaries removed: discuss CVD risk, bone density, MHT. ${Es(33)}`);
  return rsec(4,'Surgical Options',ps);
}
function sec5(p){
  const ps=[
    `Endometriosis is associated with difficulty conceiving, but <strong>many women conceive naturally</strong>. ${R(61)}`,
    `<strong>Don't use hormonal treatment to improve pregnancy chances</strong> ‚Äî it doesn't work. ${Es(39)} <strong>Don't get pregnant solely to treat endo.</strong> ${Es(60)}`,
  ];
  if(p.tryNow)ps.push(`Referral to a <strong>fertility specialist</strong> is recommended. ${R(61)} Surgery for superficial endo may improve natural pregnancy ${Es(43)}. IUI with ovarian stimulation for stage I/II ${Es(47)}. IVF if tubal compromise, male factor, or other treatments failed. ${Es(49)}`);
  if(p.futFert&&!p.tryNow){
    ps.push(`<strong>Hormonal treatment is safe and does NOT harm future fertility.</strong> ${N('1.4.5')} ${R(65)}`);
    if(p.endo)ps.push(`Both the disease AND surgery can affect egg supply over time ‚Äî discuss with your specialist. ${Es(85)}`);
    if(p.over35)ps.push(`<strong>Over 35: timing matters more.</strong> Ovarian reserve declines steeply. Earlier specialist engagement and fertility preservation discussion recommended. ${Es(59)}`);
  }
  if(p.endo||p.over35)ps.push(`<strong>Fertility preservation (egg freezing)</strong> may be worth discussing, especially with ovarian endo or planned ovarian surgery. ${Es(59)}`);
  if(!p.noFert)ps.push(`Pregnancy with endo: doesn't always improve symptoms. Slightly increased miscarriage/ectopic risk (low-quality studies) ‚Äî <strong>does not warrant increased monitoring</strong>. ${Es(62)} ${Es(63)}`);
  return rsec(5,'Fertility',ps);
}
function sec6(p){
  const ps=[
    `Pain works best as a <strong>whole-person approach</strong> ‚Äî combining medical, physical, psychological, and lifestyle strategies. ${EAU} ${SOGC}`,
    `<strong>Pelvic floor physiotherapy</strong> ‚Äî 59‚Äì64% response rates. Specialist physio (not general) relaxes tense muscles, releases trigger points, retrains function. 64% pain reduction sustained at 1 year. ${EAU} ${EV('Moderate')} ${R(12)}`,
    `<strong>CBT</strong> ‚Äî changes thought/behaviour patterns maintaining pain. Benefits comparable to medication. ${EV('Strong')} ${EV('High')} ${SOGC}`,
    `<strong>ACT</strong> ‚Äî learning to live well alongside pain. ${EV('Strong')} ${EV('High')} ${SOGC}`,
  ];
  if(p.mood)ps.push(`Your GP can set up a <strong>Mental Health Treatment Plan</strong> for Medicare-subsidised psychology.`);
  if(p.sleep)ps.push(`<strong>CBT for insomnia</strong> ‚Äî first-line for sleep difficulties, safer than long-term sleeping medication. ${EV('Strong')} ${EV('High')} ${SOGC}`);
  ps.push(`<strong>Mindfulness</strong> ‚Äî small improvements in pain and QoL. ${EV('Conditional')} ${EV('Moderate')} ${SOGC}`);
  if(p.dysp||p.relImpact)ps.push(`<strong>Sexual wellbeing</strong> ‚Äî practical strategies: communication, alternative intimacy, positioning, lubricants, pelvic physio, couples counselling. ${EAU}`);
  ps.push(`<strong>Acupuncture</strong> ‚Äî significant improvement sustained at 24 weeks. Meta-analyses support effectiveness. ${EV('Low')}‚Äì${EV('Moderate')} ${EAU}`);
  ps.push(`<strong>Diet/FODMAP</strong> may help. ${EV('Low')} <strong>Exercise</strong> ‚Äî no endo-specific evidence (research gap). ${N('Research Rec')} Evidence does <strong>not</strong> support TCM/Chinese herbal. ${N('1.4')} ${IRE}`);
  ps.push(`<strong>Medicinal cannabis</strong> ‚Äî many people use it; clinicians should discuss openly. No specific recommendations yet. ${R(12)}`);
  if(p.failMult||p.refPain||p.recur)ps.push(`<strong>Multidisciplinary pain management</strong> recommended ‚Äî especially if pain involves multiple systems or has central sensitisation features. ${R(12)} ${EAU}`);
  ps.push(`Your GP can set up a <strong>Chronic Disease Management Plan</strong> ‚Äî up to 5 Medicare-subsidised allied health visits/year (physio, psychology, dietetics). ${R(9)}`);
  return rsec(6,'Pain Management',ps);
}
function sec7(p){
  const ps=[];
  if(p.hadSurg)ps.push(`Endo can recur. <strong>Post-surgical hormonal treatment (6‚Äì12 months min)</strong> significantly reduces recurrence. ${R(67)} ${Es(65)}`);
  ps.push(`Asymptomatic endo: progression unlikely. Follow-up individualised. ${R(66)} ${Es(9)}`);
  if(p.die||p.endo)ps.push(`DIE involving bowel/bladder/ureter or endometrioma >3cm: <strong>outpatient follow-up recommended</strong>. ${N('1.7.1')}`);
  ps.push(`Associated conditions to monitor: migraine, IBS, bladder pain, chronic fatigue, fibromyalgia, depression/anxiety, autoimmune conditions, CVD risk, early menopause. ${JH} ${EAU}`);
  ps.push(`Cancer risk: <strong>NOT significantly higher overall</strong>. ${Es(104)} Small increase in ovarian/breast/endometrial/thyroid cancer ‚Äî <strong>absolute risk LOW</strong>. ${R(69)} May have reduced cervical cancer risk. <strong>No additional screening needed</strong> beyond routine. ${R(70)} ${Es(107)}`);
  return rsec(7,'Long-Term Outlook',ps);
}
function sec8(p){
  const gpQs=[];
  if(p.noInv)gpQs.push('"Can you arrange a transvaginal ultrasound?"');
  if(p.endo||p.die||p.hasRF)gpQs.push('"Can you refer me to a specialist endometriosis service?"');
  if(!p.tryNow&&p.hTried.length===0)gpQs.push('"I\'d like to discuss hormonal treatment options."');
  if(p.dysp||p.syms.includes('pelvic-pain'))gpQs.push('"Can you refer me for pelvic floor physiotherapy?"');
  if(p.syms.length>=3)gpQs.push('"Can you set up a Chronic Disease Management Plan?"');
  if(p.mood||S.symptoms['mental-health'])gpQs.push('"Can you set up a Mental Health Treatment Plan?"');
  if(p.tryNow)gpQs.push('"Can you refer me to a fertility specialist?"');
  if((p.endo||p.hadSurg)&&(p.tryNow||p.futFert))gpQs.push('"Can I have an AMH test to check ovarian reserve?"');
  if(p.adol)gpQs.push('"Can you refer me to a paediatric/adolescent gynaecologist?"');
  if(p.failMult)gpQs.push('"I\'ve tried several treatments ‚Äî what are my next options?"');

  const ps=[];
  if(gpQs.length)ps.push(`<div class="gpq"><div class="gpq__t">Questions for your GP</div><ul class="gpq__l">${gpQs.map(q=>`<li>${q}</li>`).join('')}</ul></div>`);
  ps.push(`<strong>When to seek specialist referral:</strong> treatment not effective/tolerated, imaging suggests endometrioma/DIE, severe/persistent symptoms, fertility concerns, under 18. ${N('1.5.5')} ${IRE} ${R(10)}`);
  if(p.die||p.hasRF)ps.push(`DIE involving bowel/bladder/ureter ‚Üí <strong>specialist endometriosis service</strong>. ${N('1.5.6')} ${R(11)}`);
  ps.push(`<strong>Support:</strong> Endometriosis Australia, Jean Hailes, Pelvic Pain Foundation of Australia, QENDO. Telehealth available. ${R(8)}`);
  return rsec(8,'Next Steps',ps);
}

// ============ FERTOOL BLURB ‚Äî Maps to Fertool backend attributes ============
// Phase 1: Client-side generation mimicking Fertool's output voice
// Phase 2: Replace with POST /api/endotool/generate using fertoolPayload()

function fertoolPayload(){
  // This is the exact payload that would go to Fertool's backend
  return {
    age_bracket: AGE_IDS[S.ageIdx],
    age_label: AGE_LABELS[S.ageIdx],
    diagnosis: S.diagnosis,
    phenotype: S.usResult==='endometrioma'?'endometrioma':S.usResult==='die'?'die':S.diagnosis==='adenomyosis'?'adenomyosis':'suspected',
    fertility_goal: S.fertility,
    trying_to_conceive: S.fertility==='trying-now',
    has_endometrioma: S.usResult==='endometrioma'||S.diagnosis==='us-confirmed',
    has_die: S.usResult==='die',
    has_adenomyosis: S.diagnosis==='adenomyosis',
    had_surgery: ['one-lap','multiple','recurrence','endometrioma-removed'].includes(S.surgery),
    surgery_type: S.surgery,
    hormonal_tried: Object.entries(S.hormonal).filter(([,v])=>v.tried).map(([k,v])=>({id:k,outcome:v.outcome})),
    hormonal_failed: Object.entries(S.hormonal).filter(([,v])=>v.tried&&(v.outcome==="Didn't help"||v.outcome==="Side effects")).length,
    investigations: S.investigations,
    us_result: S.usResult,
    symptoms: Object.keys(S.symptoms).filter(k=>S.symptoms[k]),
    red_flags: SYM_CARDS.find(c=>c.id==='redflag').items.filter(i=>S.symptoms[i.id]).map(i=>i.id),
    priorities: S.priorities,
    non_medical: S.nonMedical,
    pain_relief: S.painRelief,
  };
}

function buildFertoolBlurb(p){
  // Log the Fertool payload for Phase 2 integration
  const payload=fertoolPayload();
  console.log('Fertool payload:',JSON.stringify(payload,null,2));

  const age=AGE_LABELS[S.ageIdx];
  const fertConcerned=!['no-goal','completed'].includes(S.fertility);
  const name=''; // Phase 2: from user account

  // Build the personal narrative
  let greeting='';
  let body=[];
  let actions=[];

  // ---- Opening: reflect their situation back ----
  const symCount=p.syms.length;
  const painTypes=[];
  if(S.symptoms['dysmenorrhoea'])painTypes.push('severe period pain');
  if(S.symptoms['pelvic-pain'])painTypes.push('chronic pelvic pain');
  if(S.symptoms['dyspareunia'])painTypes.push('pain with intimacy');
  if(S.symptoms['dyschezia'])painTypes.push('pain with bowel movements');
  if(p.fatigue)painTypes.push('fatigue');

  const painDesc=painTypes.length>0?painTypes.slice(0,3).join(', '):'your symptoms';

  if(p.adol){
    greeting=`You're ${age}, and you deserve answers.`;
    body.push(`What you're experiencing ‚Äî ${painDesc} ‚Äî is real, it matters, and it deserves proper investigation. Too many young people are told this is "just bad periods." It's not. The fact that you're here looking for information already puts you ahead.`);
  }else if(p.tryNow){
    greeting=`Here's your situation ‚Äî and what to do about it.`;
    body.push(`You're ${age}, dealing with ${painDesc}, and actively trying to conceive. That combination needs careful navigation ‚Äî because some of the usual endometriosis treatments are off the table while you're trying, and your fertility pathway needs its own specific plan.`);
  }else if(p.over35&&fertConcerned){
    greeting=`Let's be straightforward about where you stand.`;
    body.push(`You're ${age} with ${painDesc}${p.endo?' and a confirmed endometrioma':''}. You want children ${S.fertility==='1-2-years'?'in the next 1‚Äì2 years':S.fertility==='3-5-years'?'in the next 3‚Äì5 years':'in the future'}, and at your age, timing decisions carry more weight. That's not meant to create anxiety ‚Äî it's meant to make sure you get the right specialist input at the right time.`);
  }else if(p.failMult){
    greeting=`You've tried a lot. Let's find what's next.`;
    body.push(`You're ${age}, you've been through ${p.hFail.length} treatments that didn't work well enough${p.hadSurg?' and surgery':''}. That's frustrating, and it's valid. But it also means we have a clearer picture of what your body responds to ‚Äî and there are still evidence-based options worth exploring.`);
  }else if(p.hasRF){
    greeting=`Some of your symptoms need urgent attention.`;
    body.push(`You've reported symptoms ‚Äî ${S.symptoms['cyclical-rectal']?'cyclical rectal bleeding':''}${S.symptoms['cyclical-haematuria']?', blood in urine with your cycle':''}${S.symptoms['shoulder-chest']?', cyclical chest or shoulder pain':''} ‚Äî that may indicate deep endometriosis involving the bowel, bladder, or diaphragm. This doesn't mean the worst ‚Äî but it does mean specialist assessment shouldn't wait.`);
  }else{
    greeting=`Here's what the evidence says about your situation.`;
    body.push(`You're ${age}${p.endo?', with a confirmed endometrioma':p.die?', with signs of deep endometriosis':p.adeno?', with suspected adenomyosis':' and suspecting endometriosis'}, experiencing ${painDesc}. ${symCount>4?'You\'re dealing with quite a lot ‚Äî and each of those symptoms is addressed in the detailed sections below.':'Let\'s make sure you know exactly what your options are.'}`);
  }

  // ---- Core insight: the one thing they most need to know ----
  if(p.tryNow){
    body.push(`<strong>The most important thing to know:</strong> hormonal treatments won't help you get pregnant ‚Äî and your doctor should never tell you to "just get pregnant" to treat your endo. What you need is a fertility specialist who understands endometriosis. That's your primary next step.`);
  }else if(p.endo&&fertConcerned){
    body.push(`<strong>Key insight for you:</strong> both your endometrioma and any surgery for it can affect your egg supply. That doesn't mean you'll have fertility problems ‚Äî but it means the decisions about if and when to operate need to factor in your reproductive plans. A specialist can help you weigh this up properly.`);
  }else if(p.noInv){
    body.push(`<strong>Your next step is clear:</strong> get a transvaginal ultrasound. It's the recommended first investigation, and your GP can arrange it. You can start treatment at the same time ‚Äî you don't have to wait for results before getting help with your symptoms.`);
  }else if(p.failMult){
    body.push(`<strong>Where things go from here:</strong> after multiple failed treatments, you should be seeing a specialist ‚Äî not just trying the next thing on the list. A gynaecologist with endometriosis expertise can discuss second-line medications, whether surgery might help, and a whole-of-person pain management approach.`);
  }else if(p.hasUS&&p.usNorm){
    body.push(`<strong>Important to know:</strong> your normal ultrasound does NOT rule out endometriosis. Superficial disease is often invisible on imaging. If your symptoms persist despite treatment, you still have every right to push for further investigation or specialist referral.`);
  }else if(!p.tryNow&&!p.noFert){
    body.push(`<strong>Good news:</strong> hormonal treatment for endometriosis will not permanently affect your ability to have children. It's safe and reversible. Your fertility matters, and nothing in the recommended treatment pathway puts it at risk.`);
  }

  // ---- Actionable steps ----
  if(p.tryNow){
    actions.push('Ask your GP for a fertility specialist referral');
    if(!p.hasUS)actions.push('Get a transvaginal ultrasound if you haven\'t already');
    actions.push('Discuss fertility-safe pain management options');
    if(p.endo)actions.push('Ask about ovarian reserve testing (AMH)');
  }else if(p.hasRF){
    actions.push('Discuss urgent specialist referral with your GP');
    if(!S.investigations.includes('mri'))actions.push('Request a pelvic MRI for surgical planning');
    actions.push('Read Section 4 on surgical options carefully');
  }else if(p.over35&&fertConcerned){
    actions.push('Book a specialist review ‚Äî don\'t wait until you\'re ready to conceive');
    if(p.endo)actions.push('Discuss ovarian reserve and fertility preservation');
    actions.push('Read the fertility section below for your specific situation');
  }else if(p.failMult){
    actions.push('Request referral to a gynaecologist with endo expertise');
    actions.push('Ask about a Chronic Disease Management Plan for subsidised allied health');
    actions.push('Consider pelvic floor physiotherapy and psychological support');
  }else{
    if(p.noInv)actions.push('Ask your GP to arrange a transvaginal ultrasound');
    if(p.hTried.length===0&&!p.tryNow)actions.push('Discuss first-line hormonal treatment options');
    if(p.endo||p.die)actions.push('Request specialist endometriosis service referral');
    if(p.syms.length>=3)actions.push('Ask about a Chronic Disease Management Plan');
    if(fertConcerned&&(p.endo||p.over35))actions.push('Raise fertility preservation with your specialist');
  }

  // ---- Urgency/timeline ----
  let timeline='';
  if(p.tryNow)timeline='Don\'t delay ‚Äî book your GP appointment this week to start the referral process.';
  else if(p.hasRF)timeline='This warrants prompt attention. See your GP within the next week.';
  else if(p.over35&&fertConcerned)timeline='Timing matters at your age. Aim to see your GP within the next 2‚Äì4 weeks.';
  else if(p.failMult)timeline='You\'ve been patient long enough. Request a specialist referral at your next appointment.';
  else timeline='Take this report to your next GP appointment. The detailed sections below will help you prepare.';

  body.push(timeline);

  // ---- Build HTML ----
  const actionsHtml=actions.length?`<div class="blurb__actions">${actions.map((a,i)=>`<div class="blurb__action"><span class="blurb__action-n">${i+1}</span>${a}</div>`).join('')}</div>`:'';

  return `<div class="blurb">
    <div class="blurb__inner">
      <div class="blurb__badge">‚ú¶ Your personalised assessment</div>
      <div class="blurb__greeting">${greeting}</div>
      <div class="blurb__body">${body.map(b=>`<p>${b}</p>`).join('')}</div>
      ${actionsHtml}
      <div class="blurb__note">Based on your responses and international clinical guidelines.</div>
    </div>
  </div>`;
}

const SOURCE_LEGEND=`<div class="src-leg"><div class="src-leg__t">Sources</div>
  <div class="src-leg__r"><span class="src-leg__c">RANZCOG</span><span class="src-leg__n">Australian Living Evidence Guideline: Endometriosis</span><span class="src-leg__y">2025</span></div>
  <div class="src-leg__r"><span class="src-leg__c">ESHRE</span><span class="src-leg__n">European Society of Human Reproduction & Embryology: Endometriosis</span><span class="src-leg__y">2022</span></div>
  <div class="src-leg__r"><span class="src-leg__c">NICE</span><span class="src-leg__n">National Institute for Health and Care Excellence NG73</span><span class="src-leg__y">2024</span></div>
  <div class="src-leg__r"><span class="src-leg__c">EAU-CPP</span><span class="src-leg__n">European Association of Urology: Chronic Pelvic Pain</span><span class="src-leg__y">2025</span></div>
  <div class="src-leg__r"><span class="src-leg__c">SOGC</span><span class="src-leg__n">Society of Obstetricians & Gynaecologists of Canada: Chronic Pelvic Pain</span><span class="src-leg__y">2024</span></div>
  <div class="src-leg__r"><span class="src-leg__c">Irish</span><span class="src-leg__n">Irish NCPG: Assessment & Management of Endometriosis</span><span class="src-leg__y">2025</span></div>
  <div class="src-leg__r"><span class="src-leg__c">Jean Hailes</span><span class="src-leg__n">Jean Hailes for Women's Health: GP Consult Guide</span><span class="src-leg__y">2025</span></div>
</div>`;

// ============ INIT ============
function initFertoolSearch(){
  const input=document.getElementById('ftSearchInput');
  const btn=document.getElementById('ftSearchBtn');
  const resp=document.getElementById('ftResponse');
  const respA=document.getElementById('ftResponseA');
  const respSrc=document.getElementById('ftResponseSrc');
  const loading=document.getElementById('ftLoading');
  const chipsEl=document.getElementById('ftChips');
  if(!input||!btn)return;

  const FERTOOL_API='https://fertility-gp-backend-532857641879.australia-southeast2.run.app';

  // Profile-contextual quick searches
  const fertConcerned=!['no-goal','completed'].includes(S.fertility);
  const chips=[];
  if(S.fertility==='trying-now'){
    chips.push('AMH interpretation','Referral criteria','Surgery before IVF');
  }else if(fertConcerned){
    chips.push('AMH interpretation','Egg freezing','Fertility preservation');
  }else{
    chips.push('AMH interpretation','Referral criteria','Initial workup');
  }
  if(chipsEl)chipsEl.innerHTML=chips.map(c=>`<span class="fertool-box__chip">${c}</span>`).join('');

  async function runSearch(query){
    if(!query.trim())return;
    const profileCtx=document.getElementById('ftProfileContext')?.value||'';

    // Prepend patient context to query ‚Äî same backend, richer context
    const fullQuestion=profileCtx+' Question: '+query.trim();

    loading.classList.add('show');
    resp.classList.remove('show');
    btn.disabled=true;
    btn.textContent='Searching‚Ä¶';

    try{
      // Use streaming endpoint for real-time response (same as Fertool production)
      const res=await fetch(FERTOOL_API+'/query/stream',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({question:fullQuestion})
      });

      if(!res.ok) throw new Error('API returned '+res.status);

      const reader=res.body.getReader();
      const decoder=new TextDecoder();
      let fullText='';
      loading.classList.remove('show');
      resp.classList.add('show');
      respA.innerHTML='';

      while(true){
        const {done,value}=await reader.read();
        if(done)break;
        const chunk=decoder.decode(value,{stream:true});
        // Parse SSE lines
        const lines=chunk.split('\n');
        for(const line of lines){
          if(line.startsWith('data: ')){
            const data=line.slice(6);
            if(data==='[DONE]')continue;
            try{
              const parsed=JSON.parse(data);
              if(parsed.token)fullText+=parsed.token;
              else if(parsed.text)fullText+=parsed.text;
              else if(typeof parsed==='string')fullText+=parsed;
            }catch{
              fullText+=data;
            }
          }
        }
        respA.innerHTML=fullText.replace(/\n/g,'<br>');
      }

      // If streaming didn't work or was empty, fallback to non-streaming
      if(!fullText.trim()){
        const res2=await fetch(FERTOOL_API+'/query',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({question:fullQuestion})
        });
        const data=await res2.json();
        fullText=data.response||data.answer||data.result||JSON.stringify(data);
        respA.innerHTML=fullText.replace(/\n/g,'<br>');
      }

      respSrc.textContent='Source: Fertool Guidelines Database (ASRM, RANZCOG, ESHRE)';
      resp.scrollIntoView({behavior:'smooth',block:'nearest'});

    }catch(err){
      loading.classList.remove('show');
      // Fallback to non-streaming
      try{
        const res2=await fetch(FERTOOL_API+'/query',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({question:fullQuestion})
        });
        const data=await res2.json();
        const text=data.response||data.answer||data.result||JSON.stringify(data);
        respA.innerHTML=text.replace(/\n/g,'<br>');
        respSrc.textContent='Source: Fertool Guidelines Database';
        resp.classList.add('show');
        resp.scrollIntoView({behavior:'smooth',block:'nearest'});
      }catch(err2){
        respA.innerHTML='<p>Could not reach Fertool backend. The Cloud Run service may be sleeping ‚Äî try again in a few seconds.</p>';
        respSrc.textContent='';
        resp.classList.add('show');
      }
    }finally{
      btn.disabled=false;
      btn.textContent='Search';
    }
  }

  btn.addEventListener('click',()=>runSearch(input.value));
  input.addEventListener('keydown',e=>{if(e.key==='Enter')runSearch(input.value)});
  document.querySelectorAll('.fertool-box__chip').forEach(chip=>{
    chip.addEventListener('click',()=>{input.value=chip.textContent;runSearch(chip.textContent)});
  });
}

renderScreen('f');
</script>
</body>
</html>
