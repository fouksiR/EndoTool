<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EndoTool — Evidence-Based Endometriosis Guide</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
/* ============================================
   EndoTool — Stylesheet
   Warm, trustworthy medical tool aesthetic
   ============================================ */

:root {
  --color-bg: #faf6f2;
  --color-bg-deep: #f3ece5;
  --color-surface: #ffffff;
  --color-surface-warm: #f0ebe5;
  --color-surface-highlight: #faf3ef;
  --color-primary: #b8605a;
  --color-primary-hover: #a5524d;
  --color-primary-light: rgba(184, 96, 90, 0.08);
  --color-text: #3d2e2e;
  --color-text-secondary: #6b5656;
  --color-text-muted: #8a7575;
  --color-text-faint: #b0a099;
  --color-border: #e8ddd4;
  --color-border-light: #ede4dc;
  --color-border-input: #c4b5ab;
  --color-alert-bg: #fef2f0;
  --color-alert-border: #e8847d;
  --color-alert-text: #7a2e28;
  --color-fertool: #d4bfb0;
  --font-display: 'Source Serif 4', Georgia, serif;
  --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  --max-width: 640px;
  --radius: 10px;
  --radius-lg: 16px;
}

*, *::before, *::after { box-sizing: border-box; }

body {
  margin: 0;
  font-family: var(--font-body);
  background: linear-gradient(180deg, var(--color-bg) 0%, var(--color-bg-deep) 100%);
  color: var(--color-text);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* ---- Scrollbar ---- */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 3px; }

/* ---- Animations ---- */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes slideInRight {
  from { opacity: 0; transform: translateX(40px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes slideInLeft {
  from { opacity: 0; transform: translateX(-40px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes fadeSlide {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.anim-forward { animation: slideInRight 0.3s ease; }
.anim-back { animation: slideInLeft 0.3s ease; }
.anim-fade { animation: fadeIn 0.4s ease; }

/* ---- Layout ---- */
.header, .progress, .content, .nav, .output {
  max-width: var(--max-width);
  margin: 0 auto;
  padding-left: 28px;
  padding-right: 28px;
}

@media (max-width: 480px) {
  .header, .progress, .content, .nav, .output {
    padding-left: 20px;
    padding-right: 20px;
  }
}

/* ---- Header ---- */
.header {
  padding-top: 28px;
  padding-bottom: 0;
}
.header__brand {
  display: flex;
  align-items: baseline;
  gap: 10px;
  margin-bottom: 4px;
}
.header__logo {
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 700;
  color: var(--color-text);
  letter-spacing: -0.5px;
}
.header__badge {
  font-size: 11px;
  color: var(--color-primary);
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.header__tagline {
  font-size: 13px;
  color: var(--color-text-muted);
  line-height: 1.5;
  margin: 0 0 24px;
}

/* ---- Progress ---- */
.progress { margin-bottom: 24px; }
.progress__bar {
  display: flex;
  gap: 4px;
  margin-bottom: 8px;
}
.progress__segment {
  flex: 1;
  height: 4px;
  border-radius: 2px;
  background: var(--color-border-light);
  transition: background 0.4s ease;
}
.progress__segment.active {
  background: var(--color-primary);
}
.progress__labels {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.progress__step-count,
.progress__step-name {
  font-size: 12px;
  color: var(--color-text-faint);
}
.progress__step-name { font-weight: 500; }

/* ---- Content ---- */
.content {
  padding-bottom: 0;
  min-height: 200px;
}

.screen-title {
  font-family: var(--font-display);
  font-size: 24px;
  font-weight: 700;
  color: var(--color-text);
  margin: 0 0 20px;
  line-height: 1.3;
}

.screen-hint {
  font-size: 14px;
  color: var(--color-text-muted);
  line-height: 1.6;
  margin-bottom: 20px;
}

/* ---- Form elements ---- */
.field-group {
  margin-bottom: 28px;
}
.field-group__label {
  font-family: var(--font-display);
  font-size: 17px;
  font-weight: 600;
  color: var(--color-text);
  margin-bottom: 6px;
}
.field-group__hint {
  font-size: 13px;
  color: var(--color-text-muted);
  margin-bottom: 10px;
  line-height: 1.5;
}
.field-group__options {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.field-group__options--grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
}

/* Option (checkbox or radio) */
.option {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 14px;
  border-radius: var(--radius);
  border: 2px solid var(--color-border);
  background: var(--color-surface);
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14.5px;
  line-height: 1.45;
  color: var(--color-text);
  user-select: none;
}
.option:hover {
  border-color: var(--color-border-input);
}
.option.selected {
  border-color: var(--color-primary);
  background: var(--color-surface-highlight);
}
.option input { display: none; }

/* Checkbox indicator */
.option__check {
  width: 20px;
  min-width: 20px;
  height: 20px;
  border-radius: 5px;
  border: 2px solid var(--color-border-input);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 1px;
  transition: all 0.2s ease;
  flex-shrink: 0;
}
.option.selected .option__check {
  border-color: var(--color-primary);
  background: var(--color-primary);
}
.option__check svg { display: none; }
.option.selected .option__check svg { display: block; }

/* Radio indicator */
.option__radio {
  width: 20px;
  min-width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid var(--color-border-input);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  flex-shrink: 0;
}
.option.selected .option__radio {
  border-color: var(--color-primary);
}
.option__radio-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--color-primary);
  display: none;
}
.option.selected .option__radio-dot { display: block; }

/* Sub-question */
.sub-question {
  margin-left: 20px;
  padding-left: 16px;
  border-left: 3px solid var(--color-border);
  margin-bottom: 20px;
  margin-top: 4px;
  animation: fadeSlide 0.3s ease;
}

/* Treatment outcome pills */
.outcome-pills {
  display: flex;
  gap: 6px;
  margin-top: 6px;
  margin-left: 44px;
  flex-wrap: wrap;
}
.outcome-pill {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  border: 1.5px solid var(--color-border);
  background: var(--color-surface);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: var(--font-body);
}
.outcome-pill:hover { border-color: var(--color-border-input); }
.outcome-pill.selected {
  border-color: var(--color-primary);
  background: var(--color-primary);
  color: #fff;
}

/* ---- Alert banner ---- */
.alert {
  background: var(--color-alert-bg);
  border: 2px solid var(--color-alert-border);
  border-radius: 12px;
  padding: 14px 18px;
  margin-bottom: 20px;
  display: flex;
  gap: 12px;
  align-items: flex-start;
  animation: fadeSlide 0.3s ease;
}
.alert__icon { font-size: 20px; line-height: 1; }
.alert__text {
  font-size: 14px;
  color: var(--color-alert-text);
  line-height: 1.55;
}

/* ---- Navigation ---- */
.nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 24px;
  padding-bottom: 40px;
}
.nav__btn {
  padding: 10px 24px;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: var(--font-body);
}
.nav__btn--back {
  border: 2px solid var(--color-border);
  background: var(--color-surface);
  color: var(--color-text-secondary);
}
.nav__btn--back:hover {
  border-color: var(--color-border-input);
}
.nav__btn--next {
  border: none;
  background: var(--color-primary);
  color: #fff;
  font-weight: 600;
  padding: 10px 28px;
}
.nav__btn--next:hover:not(:disabled) {
  background: var(--color-primary-hover);
}
.nav__btn--next:disabled {
  background: var(--color-border);
  cursor: default;
  opacity: 0.6;
}

/* ---- Review / Summary screen ---- */
.summary-card {
  background: var(--color-surface-warm);
  border-radius: var(--radius-lg);
  padding: 24px 28px;
  margin-bottom: 24px;
}
.summary-card__title {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 700;
  color: var(--color-text);
  margin-bottom: 16px;
}
.summary-card p {
  font-size: 14px;
  line-height: 1.7;
  color: var(--color-text-secondary);
  margin: 0 0 12px;
}
.summary-card p:last-child { margin-bottom: 0; }
.summary-card strong { color: var(--color-text); }

.summary-redflag {
  background: var(--color-alert-bg);
  border: 1.5px solid var(--color-alert-border);
  border-radius: 8px;
  padding: 8px 12px;
  margin-bottom: 12px;
  font-size: 13px;
  color: var(--color-alert-text);
}

/* Fertool link card */
.fertool-card {
  background: linear-gradient(135deg, #f8f1ec 0%, #f0e6df 100%);
  border-radius: var(--radius-lg);
  padding: 20px 24px;
  margin-bottom: 24px;
  border: 2px solid var(--color-fertool);
}
.fertool-card__header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}
.fertool-card__title {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 700;
  color: var(--color-text);
}
.fertool-card__text {
  font-size: 14px;
  color: var(--color-text-secondary);
  line-height: 1.6;
}

/* Generate button */
.generate-area {
  text-align: center;
  padding: 20px 0;
  border-top: 1px solid var(--color-border);
  margin-top: 8px;
}
.generate-area__hint {
  font-size: 14px;
  color: var(--color-text-muted);
  margin-bottom: 16px;
  line-height: 1.6;
}
.btn-generate {
  padding: 14px 40px;
  border-radius: 12px;
  border: none;
  background: var(--color-primary);
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  font-family: var(--font-display);
  box-shadow: 0 4px 16px rgba(184, 96, 90, 0.3);
  transition: all 0.2s ease;
}
.btn-generate:hover {
  background: var(--color-primary-hover);
  box-shadow: 0 6px 20px rgba(184, 96, 90, 0.4);
}
.generate-area__disclaimer {
  font-size: 12px;
  color: var(--color-text-faint);
  margin-top: 12px;
  line-height: 1.5;
}

/* ---- Output / Report ---- */
.output {
  padding-top: 20px;
  padding-bottom: 60px;
}
.output__header {
  text-align: center;
  margin-bottom: 32px;
  padding-bottom: 24px;
  border-bottom: 2px solid var(--color-border);
}
.output__title {
  font-family: var(--font-display);
  font-size: 26px;
  font-weight: 700;
  color: var(--color-text);
  margin: 0 0 8px;
}
.output__subtitle {
  font-size: 14px;
  color: var(--color-text-muted);
  line-height: 1.5;
}

.report-section {
  margin-bottom: 32px;
  animation: fadeIn 0.4s ease;
}
.report-section__number {
  font-size: 12px;
  font-weight: 600;
  color: var(--color-primary);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 6px;
}
.report-section__title {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 700;
  color: var(--color-text);
  margin: 0 0 14px;
  line-height: 1.3;
}
.report-section__content {
  font-size: 15px;
  line-height: 1.7;
  color: var(--color-text-secondary);
}
.report-section__content p {
  margin: 0 0 14px;
}
.report-section__content p:last-child { margin-bottom: 0; }
.report-section__content strong {
  color: var(--color-text);
  font-weight: 600;
}

/* Evidence tag */
.evidence-tag {
  display: inline-block;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 4px;
  background: var(--color-surface-warm);
  color: var(--color-text-muted);
  font-weight: 500;
  margin-left: 4px;
  vertical-align: middle;
}

/* Blocked treatment warning */
.blocked-warning {
  background: #fef8f0;
  border: 2px solid #e8b84d;
  border-radius: 12px;
  padding: 14px 18px;
  margin-bottom: 16px;
}
.blocked-warning__text {
  font-size: 14px;
  color: #7a5e1a;
  line-height: 1.55;
}

/* Questions for GP list */
.gp-questions {
  background: var(--color-surface-warm);
  border-radius: var(--radius-lg);
  padding: 20px 24px;
  margin-top: 16px;
}
.gp-questions__title {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 700;
  color: var(--color-text);
  margin-bottom: 12px;
}
.gp-questions__list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.gp-questions__list li {
  font-size: 14px;
  color: var(--color-text-secondary);
  line-height: 1.6;
  padding: 6px 0 6px 24px;
  position: relative;
}
.gp-questions__list li::before {
  content: "→";
  position: absolute;
  left: 0;
  color: var(--color-primary);
  font-weight: 600;
}

/* Fertool CTA in report */
.fertool-cta {
  background: linear-gradient(135deg, #f8f1ec 0%, #efe4da 100%);
  border: 2px solid var(--color-fertool);
  border-radius: var(--radius-lg);
  padding: 20px 24px;
  margin-top: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.fertool-cta:hover {
  border-color: var(--color-primary);
  box-shadow: 0 4px 12px rgba(184, 96, 90, 0.15);
}
.fertool-cta__label {
  font-size: 12px;
  font-weight: 600;
  color: var(--color-primary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}
.fertool-cta__title {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 700;
  color: var(--color-text);
  margin-bottom: 6px;
}
.fertool-cta__text {
  font-size: 14px;
  color: var(--color-text-secondary);
  line-height: 1.5;
}

/* Back to top / restart */
.output__actions {
  text-align: center;
  margin-top: 40px;
  padding-top: 24px;
  border-top: 1px solid var(--color-border);
}
.btn-restart {
  padding: 10px 28px;
  border-radius: var(--radius);
  border: 2px solid var(--color-border);
  background: var(--color-surface);
  color: var(--color-text-secondary);
  font-size: 14px;
  cursor: pointer;
  font-family: var(--font-body);
  transition: all 0.2s ease;
}
.btn-restart:hover { border-color: var(--color-border-input); }
  </style>
</head>
<body>
  <header class="header">
    <div class="header__brand">
      <span class="header__logo">EndoTool</span>
      <span class="header__badge">Evidence-Based Guide</span>
    </div>
    <p class="header__tagline">A guided tool to help you understand your endometriosis and prepare for medical appointments.</p>
  </header>

  <div class="progress">
    <div class="progress__bar">
      <div class="progress__segment" data-step="0"></div>
      <div class="progress__segment" data-step="1"></div>
      <div class="progress__segment" data-step="2"></div>
      <div class="progress__segment" data-step="3"></div>
      <div class="progress__segment" data-step="4"></div>
    </div>
    <div class="progress__labels">
      <span class="progress__step-count">Step 1 of 5</span>
      <span class="progress__step-name">About You</span>
    </div>
  </div>

  <main class="content" id="content"></main>

  <nav class="nav" id="nav">
    <button class="nav__btn nav__btn--back" id="btn-back" style="visibility:hidden">← Back</button>
    <button class="nav__btn nav__btn--next" id="btn-next" disabled>Continue →</button>
  </nav>

  <section class="output" id="output" style="display:none"></section>

  <script>
/**
 * EndoTool — Clinical Content Data
 * Hardcoded evidence-based content blocks from guidelines.
 * LLM never generates this content — it only translates it.
 * 
 * Sources: RANZCOG 2025 (R), ESHRE 2022 (E), NICE NG73 2024 (N),
 *          EAU CPP 2025, SOGC CPP 2024, Irish NCPG 2025, Jean Hailes 2025
 */

const SCREEN_NAMES = [
  "About You",
  "Your Symptoms",
  "Investigations",
  "Treatments Tried",
  "Fertility & Goals"
];

// ---- Intake option definitions ---- //

const INTAKE = {
  age: [
    { id: "under18", label: "Under 18" },
    { id: "18-24", label: "18–24" },
    { id: "25-34", label: "25–34" },
    { id: "35-39", label: "35–39" },
    { id: "40+", label: "40+" },
  ],
  diagnosis: [
    { id: "suspected", label: "No — I suspect I might have it" },
    { id: "us-confirmed", label: "Yes — confirmed by ultrasound (endometrioma or deep endo seen)" },
    { id: "lap-confirmed", label: "Yes — confirmed by laparoscopy / surgery" },
    { id: "adenomyosis", label: "I've been told I might have adenomyosis (or both)" },
  ],
  painSymptoms: [
    { id: "dysmenorrhoea", label: "Painful periods (severe enough to affect school, work, or daily activities)" },
    { id: "pelvic-pain", label: "Pelvic pain outside of your period" },
    { id: "dyspareunia", label: "Pain during or after sex" },
    { id: "dyschezia", label: "Pain with bowel movements" },
    { id: "dysuria", label: "Pain when urinating" },
    { id: "back-pain", label: "Back pain related to your cycle" },
    { id: "refractory-pain", label: "Pain that hasn't responded well to standard painkillers" },
  ],
  bleedingSymptoms: [
    { id: "heavy-bleeding", label: "Heavy menstrual bleeding" },
    { id: "irregular-bleeding", label: "Irregular bleeding" },
  ],
  bowelBladder: [
    { id: "cyclical-bowel", label: "Constipation or diarrhoea that worsens around your period" },
    { id: "bloating", label: "Bloating" },
    { id: "urinary-freq", label: "Urinary frequency or urgency" },
    { id: "haematuria", label: "Blood in urine around your period" },
    { id: "rectal-bleeding", label: "Blood in stool around your period" },
  ],
  generalSymptoms: [
    { id: "fatigue", label: "Severe fatigue / tiredness" },
    { id: "sleep", label: "Sleep difficulties" },
    { id: "headache", label: "Headaches" },
    { id: "mood", label: "Low mood or anxiety related to your condition" },
  ],
  lifeImpact: [
    { id: "missing-work", label: "Missing work or school" },
    { id: "avoiding-activity", label: "Avoiding physical activity or exercise" },
    { id: "relationship", label: "Impact on your relationship or intimacy" },
    { id: "mental-health", label: "Impact on your mental health or emotional wellbeing" },
  ],
  riskFactors: [
    { id: "family-hx", label: "A first-degree relative (mother, sister) with endometriosis" },
    { id: "autoimmune", label: "History of autoimmune disease" },
    { id: "early-menarche", label: "Periods started before age 11" },
    { id: "short-cycles", label: "Menstrual cycles shorter than 27 days" },
  ],
  redFlags: [
    { id: "cyclical-rectal", label: "Rectal bleeding that comes and goes with your cycle" },
    { id: "cyclical-haematuria", label: "Blood in your urine that comes and goes with your cycle" },
    { id: "shoulder-chest", label: "Cyclical shoulder tip pain or chest pain" },
  ],
  investigations: [
    { id: "none", label: "None — I haven't had any tests yet" },
    { id: "exam", label: "Physical / pelvic examination" },
    { id: "tvus", label: "Pelvic ultrasound — transvaginal (internal)" },
    { id: "taus", label: "Pelvic ultrasound — transabdominal (external, on your tummy)" },
    { id: "amh", label: "Blood test for AMH (ovarian reserve)" },
    { id: "mri", label: "Pelvic MRI" },
    { id: "laparoscopy", label: "Laparoscopy (keyhole surgery)" },
  ],
  usResult: [
    { id: "normal", label: "Normal / nothing found" },
    { id: "endometrioma", label: "They found a cyst on my ovary (endometrioma)" },
    { id: "die", label: "They found signs of deep endometriosis" },
    { id: "unsure", label: "I'm not sure / wasn't told clearly" },
  ],
  painRelief: [
    { id: "paracetamol", label: "Paracetamol" },
    { id: "nsaids", label: "Anti-inflammatories (ibuprofen, naproxen, etc.)" },
    { id: "prescription", label: "Prescription painkillers (codeine, tramadol, etc.)" },
  ],
  hormonalTreatments: [
    { id: "coc", label: "Combined oral contraceptive pill (the Pill)" },
    { id: "pop", label: "Progestogen-only pill (mini pill)" },
    { id: "mirena", label: "Mirena IUD" },
    { id: "implant", label: "Contraceptive implant (Implanon)" },
    { id: "depo", label: "Depo-Provera injection" },
    { id: "gnrha", label: "GnRH agonist (e.g., Zoladex, Lupron)" },
    { id: "gnrhant", label: "GnRH antagonist (e.g., Orilissa/elagolix)" },
  ],
  hormonalOutcomes: ["Helped", "Didn't help", "Side effects", "Currently on"],
  nonMedical: [
    { id: "physio", label: "Pelvic floor physiotherapy" },
    { id: "psychology", label: "Psychology or counselling" },
    { id: "acupuncture", label: "Acupuncture" },
    { id: "exercise", label: "Regular exercise program" },
    { id: "diet", label: "Dietary changes (e.g., anti-inflammatory, FODMAP)" },
    { id: "supplements", label: "Supplements (e.g., omega-3, curcumin)" },
    { id: "mindfulness", label: "Mindfulness or meditation" },
  ],
  surgery: [
    { id: "none", label: "No surgery" },
    { id: "one-lap", label: "One laparoscopy" },
    { id: "multiple", label: "More than one surgery" },
    { id: "recurrence", label: "Surgery and endometriosis came back afterwards" },
    { id: "endometrioma-removed", label: "Endometrioma removed from ovary" },
  ],
  fertilityUnder35: [
    { id: "trying-now", label: "I'm actively trying to get pregnant now" },
    { id: "future", label: "I'd like to have children in the future" },
    { id: "unsure", label: "I'm not sure about my fertility plans" },
    { id: "no-goal", label: "Having children is not a goal for me" },
    { id: "completed", label: "I've completed my family" },
  ],
  fertilityOver35: [
    { id: "trying-now", label: "I'm actively trying to get pregnant now" },
    { id: "1-2-years", label: "I'd like to have children in the next 1–2 years" },
    { id: "3-5-years", label: "I'd like to have children in the next 3–5 years" },
    { id: "unsure", label: "I'm not sure about my fertility plans" },
    { id: "no-goal", label: "Having children is not a goal for me" },
    { id: "completed", label: "I've completed my family" },
  ],
  priorities: [
    { id: "reduce-pain", label: "Reducing my pain" },
    { id: "understand", label: "Understanding my condition better" },
    { id: "protect-fertility", label: "Protecting my ability to have children in the future" },
    { id: "get-pregnant", label: "Getting pregnant" },
    { id: "improve-qol", label: "Improving my quality of life" },
    { id: "get-diagnosis", label: "Getting a diagnosis" },
    { id: "prepare-specialist", label: "Preparing for a specialist appointment" },
    { id: "understand-surgery", label: "Understanding whether surgery might help" },
    { id: "non-medical", label: "Finding non-medical ways to manage my symptoms" },
  ],
};

// ---- Output content blocks ---- //
// These are the hardcoded clinical content that the output engine assembles.
// In Phase 2, the LLM translation layer will convert these to natural language.
// For Phase 1, they're served as-is (already in patient-friendly language).

const CONTENT = {

  // Section 1: Understanding
  understanding: {
    prevalence: "Endometriosis affects approximately 1 in 7 Australian women. It's a common condition — you are not alone.",
    delay: "The average time from first symptoms to diagnosis in Australia is 6.5 years. If you've been struggling for a while without answers, that's unfortunately common — but it doesn't have to continue.",
    painNotStage: "An important thing to know: the severity of your pain does NOT necessarily match the extent of the disease. Some people with minimal endometriosis have severe pain, while others with extensive disease have few symptoms. This means your pain is real and valid regardless of what any scan shows.",
    chronic: "Endometriosis is a chronic condition — meaning it's usually something managed over time rather than \"cured\" with a single treatment. The good news is there are many evidence-based approaches to manage it effectively.",
    validation_adolescent: "Your pain is real and deserves investigation. Period pain that stops you going to school or doing normal activities is NOT something you just have to put up with. You deserve proper assessment and treatment.",
    family_history: "Having a first-degree relative (mother, sister) with endometriosis is a recognised risk factor. Your family history adds weight to investigating your symptoms.",
    cyclical_bowel: "Cyclical bowel or bladder symptoms — especially constipation, diarrhoea, or blood in your stool that worsens around your period — can indicate deeper endometriosis. This is important information for your doctor and may change which investigations are recommended.",
    central_sensitisation: "When pain persists for a long time, the nervous system itself can change. The pain-processing centres in your brain and spinal cord become more sensitive — like turning up the volume on pain signals. This means pain can feel more intense than expected, spread beyond the original site, or persist even after the original cause has been treated. This is NOT \"in your head\" — it is a real, measurable change in how your nervous system works. Understanding this helps because it means treatment may need to address the pain pathways themselves, not just the endometriosis.",
    comorbidity: "Endometriosis commonly co-exists with other conditions. If you experience any of the following, mention them to your doctor as they may be connected: migraine, irritable bowel symptoms (IBS), bladder pain, chronic fatigue, low mood or anxiety, pain during intimacy. Addressing these alongside your endometriosis can improve your overall wellbeing.",
    pain_education: "Understanding how pain works is recognised as an important part of managing it. Research shows that people who understand pain mechanisms often experience better outcomes. Your doctor or allied health team can help you understand more about this.",
  },

  // Section 2: Investigations
  investigations: {
    tvus_first: "Current Australian guidelines recommend a <strong>transvaginal ultrasound</strong> as the first-line investigation, even if a physical examination is normal. This can identify endometriomas (cysts), deep endo, and other conditions.",
    normal_us: "<strong>A normal ultrasound does NOT rule out endometriosis</strong> — particularly superficial peritoneal disease, which is often too small to see on imaging. If your symptoms persist despite treatment, further investigation or specialist referral is still appropriate.",
    mri: "<strong>MRI is recommended</strong> if deep endometriosis is suspected, primarily to map the extent for surgical planning.",
    ca125_no: "A <strong>CA-125 blood test is NOT recommended</strong> for diagnosing endometriosis — it's not accurate enough and can cause unnecessary anxiety.",
    laparoscopy: "<strong>Laparoscopy (keyhole surgery)</strong> can be considered even when imaging is normal, if symptoms persist despite treatment. A negative biopsy during laparoscopy doesn't entirely rule out endometriosis either.",
    parallel: "You don't have to wait for all results before starting treatment. <strong>Investigations, referral, and initial treatment can happen at the same time.</strong>",
    no_investigations: "Your GP can arrange an ultrasound. You can also start treatment while waiting for test results.",
    us_normal: "A normal ultrasound doesn't rule out endometriosis. If your symptoms persist despite treatment, further investigation or specialist referral is appropriate.",
    endometrioma_found: "An endometrioma (sometimes called a \"chocolate cyst\") on ultrasound confirms endometriosis. Guidelines recommend <strong>referral to a specialist endometriosis service</strong>.",
    die_found: "Signs of deep endometriosis on ultrasound usually mean an <strong>MRI is recommended</strong> to map the extent before any surgical planning.",
    adolescent_imaging: "For younger people, a <strong>transabdominal ultrasound</strong> (external, on your tummy) is an option when a transvaginal ultrasound isn't suitable. MRI or transperineal ultrasound can also be considered by a specialist.",
  },

  // Section 3: Medical treatment
  medical: {
    firstline_intro: "All first-line hormonal treatments have similar effectiveness for pain. The choice depends on your preferences, lifestyle, and how you respond. Options include:",
    firstline_options: "<strong>Combined oral contraceptive pill</strong> (can be taken continuously to skip periods), <strong>progestogen-only pill</strong>, <strong>Mirena IUD</strong>, <strong>contraceptive implant</strong> (Implanon), and <strong>Depo-Provera injection</strong>.",
    review_3months: "Your doctor should review after about 3 months. If the first option doesn't suit you, try a different first-line option for another 3 months before escalating.",
    no_fertility_harm: "Hormonal treatment will not permanently affect your ability to have children in the future.",
    secondline: "If first-line treatments haven't worked, your specialist may discuss: <strong>GnRH agonists</strong> (e.g., Zoladex) or <strong>GnRH antagonists</strong> (e.g., Orilissa/elagolix) — these require add-back hormone therapy to prevent bone loss and menopausal symptoms. <strong>Aromatase inhibitors</strong> are an option for pain that hasn't responded to other medical or surgical treatment.",
    nsaids: "A short trial of anti-inflammatories (like ibuprofen or naproxen) ± paracetamol is a reasonable first step for pain. Anti-inflammatories are effective for period pain but evidence is less clear for non-menstrual pelvic pain.",
    no_opioids: "<strong>Opioids are NOT recommended for long-term chronic pelvic pain.</strong> They can worsen pain over time and carry significant risks.",
    neuropathic: "If your pain has features of nerve sensitisation (widespread pain, pain persisting despite treatment), your doctor may consider <strong>tricyclic antidepressants at low doses</strong>. These are prescribed for pain pathways, not mood — at doses much lower than for depression.",
    blocked_trying: "<strong>Because you are actively trying to get pregnant, hormonal treatment is NOT recommended</strong> — it does not improve your chances of conceiving. Your doctor should NOT advise you to become pregnant solely to treat endometriosis.",
    adenomyosis: "For adenomyosis specifically, treatment options include dienogest, oral contraceptives, Mirena IUD, or contraceptive implant. Your doctor should review after 3 months. GnRH agonists are a second-line option, and hormonal therapy should be considered before hysterectomy.",
  },

  // Section 4: Surgery
  surgery: {
    principles: "Surgery should be <strong>laparoscopic (keyhole)</strong> unless contraindicated. Treatment is guided by your symptoms and preferences, NOT by the stage or extent of disease. Your surgeon should discuss what surgery involves, that it may or may not improve symptoms, benefits AND risks, and the possibility of needing further surgery.",
    excision_endometrioma: "For endometriomas, <strong>excision (removing the cyst wall) is generally preferred</strong> — lower recurrence rates. But ovarian reserve impact must be considered, especially if fertility is important.",
    excision_superficial: "For superficial endometriosis, evidence does not clearly support one technique (excision vs ablation) over the other.",
    superficial_pain: "There is limited evidence that surgery for superficial endometriosis improves pain. However, it may improve spontaneous pregnancy if fertility is a priority.",
    endometrioma_ivf: "<strong>If you're planning IVF, surgery for an endometrioma before IVF is NOT routinely recommended</strong> — no benefit for IVF outcomes and likely negative impact on ovarian reserve. Exception: surgery can be considered if the endometrioma causes significant pain or blocks access to follicles.",
    die_surgery: "Surgical removal of deep endometriosis may reduce pain and improve quality of life. This requires <strong>specialist surgical expertise</strong> — you should be referred to a specialist endometriosis centre. A 3-month course of GnRH agonist before surgery may be considered for DIE involving bowel, bladder, or ureter.",
    die_fertility: "For deep endometriosis and fertility: there is <strong>no clear evidence that surgery improves fertility outcomes</strong>. The decision is guided by pain and patient preference.",
    repeat_surgery: "Repeat surgery needs <strong>careful consideration</strong> — there are diminishing returns and additional risks including adhesion formation.",
    recurrence_prevention: "After surgery, hormonal treatment for at least 6–12 months is recommended to reduce recurrence. Options include the pill, progestogens, Mirena IUD, or GnRH agonist.",
    hysterectomy: "Hysterectomy (with removal of all visible endometriosis) can be considered if you have no fertility goal AND other treatments have failed. <strong>Important: hysterectomy will NOT necessarily cure symptoms or disease.</strong> If ovaries are removed, discuss long-term consequences — cardiovascular risk, bone density, and the need for hormone replacement therapy.",
  },

  // Section 5: Fertility
  fertility: {
    basics: "Endometriosis is associated with difficulty conceiving, but <strong>many women with endometriosis conceive naturally</strong>. If fertility is a priority, management should involve a multidisciplinary team with fertility specialist access.",
    no_hormones_for_fertility: "<strong>Do NOT use hormonal treatment to improve pregnancy chances</strong> — it doesn't work for that purpose.",
    no_pregnancy_as_treatment: "<strong>Do NOT get pregnant solely to treat endometriosis</strong> — pregnancy doesn't always improve symptoms.",
    trying_now: "You should be referred to a <strong>fertility specialist</strong>. If a laparoscopy is performed and superficial endometriosis is found, surgical treatment at the same time may improve your chance of natural pregnancy. IUI with ovarian stimulation may increase pregnancy rates for milder endometriosis. IVF is indicated if tubal compromise, male factor, low fertility index, or other treatments have failed.",
    future_safe: "Hormonal treatment is safe and <strong>does NOT harm future fertility</strong>. If you've had surgery, post-surgical hormonal suppression is recommended.",
    ovarian_endo: "With ovarian endometriosis, both the disease itself AND surgery for it can affect your egg supply over time. This is worth discussing with your specialist.",
    over35_urgent: "Because you're over 35 and want children in the future, <strong>timing matters more</strong>. Ovarian reserve declines more steeply with age. Earlier specialist engagement and fertility preservation discussion are recommended.",
    preservation: "Fertility preservation (egg freezing) may be worth discussing with your specialist, especially if you have ovarian endometriosis or are planning surgery that could affect your ovaries.",
    pregnancy_endo: "Pregnancy does not always improve endometriosis symptoms. There is a slightly increased risk of first trimester miscarriage and ectopic pregnancy, but these findings are from lower-quality studies and <strong>do not warrant increased monitoring</strong> or dissuade you from becoming pregnant.",
  },

  // Section 6: Pain management
  pain: {
    framing: "Pain management in endometriosis works best as a <strong>whole-person approach</strong>. Research shows that combining medical treatment with physical, psychological, and lifestyle strategies gives better results than any single approach alone. This is called the biopsychosocial model — it recognises that pain is influenced by physical, emotional, and social factors.",
    physio: "<strong>Pelvic floor physiotherapy</strong> — Endometriosis pain can cause your pelvic floor muscles to tighten as a protective response. Over time, this tension becomes a self-sustaining source of pain (the pain-spasm-pain cycle). Specialist pelvic physiotherapy works by relaxing tense muscles, releasing trigger points, improving posture, and retraining muscle function. Studies show 59–64% response rates. <em>Important: this must be with a physiotherapist specifically trained in pelvic floor — not a general physio.</em>",
    cbt: "<strong>Cognitive Behavioural Therapy (CBT)</strong> — Changes thought patterns and behaviours that maintain pain. Benefits comparable to medication. <em>Strong recommendation, High evidence.</em>",
    act: "<strong>Acceptance and Commitment Therapy (ACT)</strong> — Learning to live well alongside pain rather than fighting it. <em>Strong recommendation, High evidence.</em>",
    mindfulness: "<strong>Mindfulness meditation</strong> — Small improvements in pain and quality of life. <em>Conditional recommendation, Moderate evidence.</em>",
    cbt_insomnia: "<strong>CBT for insomnia</strong> — First-line treatment for sleep difficulties. Safer than long-term sleeping medication. <em>Strong recommendation, High evidence.</em>",
    sexual: "<strong>Sexual wellbeing</strong> — Pain during or after sex is one of the most common and distressing symptoms. Strategies that may help: open communication with your partner, alternative forms of intimacy, different positions, pacing and planning, vaginal lubricants, pelvic floor physiotherapy (addresses muscle tension), and couples counselling.",
    acupuncture: "<strong>Acupuncture</strong> may provide pain improvement. One well-designed study showed significant improvement sustained at 24 weeks. Meta-analyses generally support its effectiveness and safety. <em>Evidence: Low–Moderate.</em>",
    diet: "<strong>Diet and nutrition</strong> — Low-FODMAP diet and some supplements may help manage symptoms. <em>Evidence: Limited/Low.</em>",
    exercise: "<strong>Exercise</strong> — No high-quality endometriosis-specific evidence exists (this is a recognised research gap). General chronic pain evidence supports regular physical activity.",
    no_tcm: "Evidence does <strong>not</strong> support traditional Chinese medicine or Chinese herbal medicine for endometriosis.",
    cannabis: "Many people with endometriosis use medicinal cannabis. Your clinician should be open to discussing this. However, there are currently no specific recommendations due to very limited evidence.",
    mdt: "For ongoing pain after medical and/or surgical treatment, <strong>referral to a multidisciplinary pain management team</strong> is recommended. This is especially important if pain has features of central sensitisation, involves multiple systems, or hasn't been adequately controlled by previous treatments.",
    cdmp: "Your GP can set up a <strong>Chronic Disease Management Plan</strong> (formerly EPC plan), giving you access to up to 5 Medicare-subsidised allied health visits per year — covering pelvic physiotherapy, psychology, dietetics, and exercise physiology.",
    mhtp: "Your GP can also set up a <strong>Mental Health Treatment Plan</strong>, providing Medicare-subsidised psychology sessions.",
  },

  // Section 7: Long-term outlook
  longterm: {
    recurrence: "Endometriosis can recur after treatment. Post-surgical hormonal treatment (minimum 6–12 months) significantly reduces recurrence. Options include the combined pill, progestogens, Mirena IUD, or GnRH agonist.",
    asymptomatic: "If endometriosis is found but isn't causing symptoms, progression is unlikely. Follow-up is individualised.",
    monitoring: "If you have deep endometriosis involving bowel, bladder, or ureter, or an endometrioma larger than 3cm, outpatient follow-up is recommended.",
    comorbidities: "Endometriosis is associated with several other conditions — being aware helps your overall health management: migraine, IBS, bladder pain, chronic fatigue, fibromyalgia, depression and anxiety, autoimmune conditions (SLE, RA, IBD), cardiovascular disease risk, and early menopause.",
    cancer: "Endometriosis is <strong>NOT associated with a significantly higher risk of cancer overall</strong>. There is a small increase in ovarian, breast, endometrial, and thyroid cancer risk — but the <strong>absolute risk increase is LOW</strong>. You may actually have a reduced cervical cancer risk. No additional cancer screening is recommended beyond routine cervical screening. Reassurance is appropriate.",
  },

  // Section 8: Next steps
  nextsteps: {
    referral_criteria: "You should ask about specialist referral if: initial treatment hasn't been effective or tolerated, imaging suggests endometrioma or deep endo, symptoms are severe/persistent/recurrent, you have ongoing fertility concerns, or you're under 18 (paediatric/adolescent gynaecologist recommended).",
    specialist_endo: "For suspected or confirmed deep endometriosis involving bowel, bladder, or ureter — referral to a <strong>specialist endometriosis service</strong> is recommended.",
    resources_au: "<strong>Support resources:</strong> Endometriosis Australia (endometriosisaustralia.org), Jean Hailes for Women's Health (jeanhailes.org.au), Pelvic Pain Foundation of Australia (pelvicpain.org.au), QENDO — Queensland (qendo.org.au). Telehealth is available for rural and remote patients.",
  },

  // Red flag content
  redFlag: {
    banner: "⚠️ <strong>The symptoms you've reported may indicate deep endometriosis involving the bowel, bladder, or diaphragm.</strong> This requires specialist assessment. We recommend discussing urgent specialist referral with your GP.",
  },
};

/**
 * EndoTool — Screen Renderers
 * Pure HTML generation for each intake screen.
 * No framework dependencies.
 */

const Screens = {

  // ---- Helper: render a checkbox option ----
  checkbox(item, groupName, isChecked) {
    return `
      <label class="option ${isChecked ? 'selected' : ''}" data-group="${groupName}" data-id="${item.id}">
        <input type="checkbox" ${isChecked ? 'checked' : ''}>
        <span class="option__check">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
            <path d="M2.5 6L5 8.5L9.5 3.5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span>${item.label}</span>
      </label>`;
  },

  // ---- Helper: render a radio option ----
  radio(item, groupName, isSelected) {
    return `
      <label class="option ${isSelected ? 'selected' : ''}" data-group="${groupName}" data-id="${item.id}">
        <input type="radio" name="${groupName}" ${isSelected ? 'checked' : ''}>
        <span class="option__radio">
          <span class="option__radio-dot"></span>
        </span>
        <span>${item.label}</span>
      </label>`;
  },

  // ---- Helper: render a field group ----
  fieldGroup(label, hint, content) {
    return `
      <div class="field-group">
        <div class="field-group__label">${label}</div>
        ${hint ? `<div class="field-group__hint">${hint}</div>` : ''}
        <div class="field-group__options">
          ${content}
        </div>
      </div>`;
  },

  // ---- Helper: treatment row with outcome pills ----
  treatmentRow(item, groupName, data) {
    const isChecked = data && data.tried;
    let pills = '';
    if (isChecked) {
      pills = `<div class="outcome-pills">
        ${INTAKE.hormonalOutcomes.map(o =>
          `<button class="outcome-pill ${data.outcome === o ? 'selected' : ''}" data-group="${groupName}" data-id="${item.id}" data-outcome="${o}">${o}</button>`
        ).join('')}
      </div>`;
    }
    return `
      <label class="option ${isChecked ? 'selected' : ''}" data-group="${groupName}" data-id="${item.id}">
        <input type="checkbox" ${isChecked ? 'checked' : ''}>
        <span class="option__check">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
            <path d="M2.5 6L5 8.5L9.5 3.5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span>${item.label}</span>
      </label>
      ${pills}`;
  },

  // ================================================
  // SCREEN 0: About You
  // ================================================
  screen0(state) {
    const ageOptions = INTAKE.age.map(a => this.radio(a, 'age', state.age === a.id)).join('');
    const diagOptions = INTAKE.diagnosis.map(d => this.radio(d, 'diagnosis', state.diagnosis === d.id)).join('');

    return `
      <h2 class="screen-title">About You</h2>
      ${this.fieldGroup('What is your age range?', null, ageOptions)}
      ${this.fieldGroup('Have you been diagnosed with endometriosis?', null, diagOptions)}
    `;
  },

  // ================================================
  // SCREEN 1: Symptoms
  // ================================================
  screen1(state) {
    const painOpts = INTAKE.painSymptoms.map(s => this.checkbox(s, 'painSymptoms', state.painSymptoms.includes(s.id))).join('');
    const bleedOpts = INTAKE.bleedingSymptoms.map(s => this.checkbox(s, 'bleedingSymptoms', state.bleedingSymptoms.includes(s.id))).join('');
    const bowelOpts = INTAKE.bowelBladder.map(s => this.checkbox(s, 'bowelBladder', state.bowelBladder.includes(s.id))).join('');
    const generalOpts = INTAKE.generalSymptoms.map(s => this.checkbox(s, 'generalSymptoms', state.generalSymptoms.includes(s.id))).join('');
    const impactOpts = INTAKE.lifeImpact.map(s => this.checkbox(s, 'lifeImpact', state.lifeImpact.includes(s.id))).join('');
    const riskOpts = INTAKE.riskFactors.map(s => this.checkbox(s, 'riskFactors', state.riskFactors.includes(s.id))).join('');
    const redFlagOpts = INTAKE.redFlags.map(s => this.checkbox(s, 'redFlags', state.redFlags.includes(s.id))).join('');

    const redFlagAlert = state.redFlags.length > 0 ? `
      <div class="alert">
        <span class="alert__icon">⚠️</span>
        <div class="alert__text">The symptoms you've ticked may indicate deep endometriosis involving the bowel, bladder, or diaphragm. This information will be flagged prominently in your results, and specialist assessment is recommended.</div>
      </div>` : '';

    return `
      <h2 class="screen-title">Your Symptoms</h2>
      <p class="screen-hint">Tick all that currently apply. Be honest — every symptom matters and helps build the full picture.</p>
      ${this.fieldGroup('Pain symptoms', null, painOpts)}
      ${this.fieldGroup('Bleeding symptoms', null, bleedOpts)}
      ${this.fieldGroup('Bowel and bladder symptoms', null, bowelOpts)}
      ${this.fieldGroup('General symptoms', null, generalOpts)}
      ${this.fieldGroup('Impact on your life', null, impactOpts)}
      ${this.fieldGroup('Risk factors', null, riskOpts)}
      ${this.fieldGroup('⚠ Red flags — these require urgent attention',
        'If any of these apply, please tick them. They may indicate deeper endometriosis that needs specialist assessment.',
        redFlagOpts
      )}
      ${redFlagAlert}
    `;
  },

  // ================================================
  // SCREEN 2: Investigations
  // ================================================
  screen2(state) {
    const invOpts = INTAKE.investigations.map(i => this.checkbox(i, 'investigations', state.investigations.includes(i.id))).join('');

    const hasUS = state.investigations.includes('tvus') || state.investigations.includes('taus');
    const usSubQ = hasUS ? `
      <div class="sub-question">
        ${this.fieldGroup('What were you told about the ultrasound results?', null,
          INTAKE.usResult.map(r => this.radio(r, 'usResult', state.usResult === r.id)).join('')
        )}
      </div>` : '';

    return `
      <h2 class="screen-title">Investigations You've Had</h2>
      ${this.fieldGroup('Which investigations have you had?', "Tick all that apply. It's fine if you haven't had any yet.", invOpts)}
      ${usSubQ}
    `;
  },

  // ================================================
  // SCREEN 3: Treatments
  // ================================================
  screen3(state) {
    const painOpts = INTAKE.painRelief.map(p => this.checkbox(p, 'painRelief', state.painRelief.includes(p.id))).join('');

    const hormonalRows = INTAKE.hormonalTreatments.map(h =>
      this.treatmentRow(h, 'hormonal', state.hormonal[h.id])
    ).join('');

    const nonMedOpts = INTAKE.nonMedical.map(n => this.checkbox(n, 'nonMedical', state.nonMedical.includes(n.id))).join('');
    const surgOpts = INTAKE.surgery.map(s => this.radio(s, 'surgery', state.surgery === s.id)).join('');

    return `
      <h2 class="screen-title">Treatments You've Tried</h2>
      ${this.fieldGroup('Pain relief you\'ve tried', null, painOpts)}
      ${this.fieldGroup('Hormonal treatments', 'Tick any you\'ve tried, then select how it went.', hormonalRows)}
      ${this.fieldGroup('Non-medical treatments you\'ve tried', null, nonMedOpts)}
      ${this.fieldGroup('Surgery', null, surgOpts)}
    `;
  },

  // ================================================
  // SCREEN 4: Fertility & Goals
  // ================================================
  screen4(state) {
    const isOver35 = state.age === '35-39' || state.age === '40+';
    const fertOptions = isOver35 ? INTAKE.fertilityOver35 : INTAKE.fertilityUnder35;
    const fertOpts = fertOptions.map(f => this.radio(f, 'fertility', state.fertility === f.id)).join('');
    const prioOpts = INTAKE.priorities.map(p => this.checkbox(p, 'priorities', state.priorities.includes(p.id))).join('');

    return `
      <h2 class="screen-title">Fertility & Life Goals</h2>
      ${this.fieldGroup('Your fertility situation', null, fertOpts)}
      ${this.fieldGroup(
        'What matters most to you right now?',
        "Tick ALL that apply — don't limit yourself. This helps us cover everything that's important to you.",
        prioOpts
      )}
    `;
  },

  // ================================================
  // SCREEN 5: Review & Generate
  // ================================================
  screen5(state) {
    const isOver35 = state.age === '35-39' || state.age === '40+';
    const symptomCount = [...state.painSymptoms, ...state.bleedingSymptoms, ...state.bowelBladder, ...state.generalSymptoms].length;
    const hormonalTriedCount = Object.values(state.hormonal).filter(h => h.tried).length;
    const hormonalFailedCount = Object.values(state.hormonal).filter(h => h.tried && (h.outcome === "Didn't help" || h.outcome === "Side effects")).length;

    const ageLabel = state.age === 'under18' ? 'Under 18' : state.age;
    const diagLabel = { suspected: 'Suspected', 'us-confirmed': 'Ultrasound-confirmed', 'lap-confirmed': 'Laparoscopy-confirmed', adenomyosis: 'Adenomyosis (possible overlap)' }[state.diagnosis] || '';
    const surgLabel = { none: 'None', 'one-lap': 'One laparoscopy', multiple: 'Multiple surgeries', recurrence: 'Surgery with recurrence', 'endometrioma-removed': 'Endometrioma removed' }[state.surgery] || '';
    const fertLabel = {
      'trying-now': 'Actively trying to conceive',
      future: 'Wants children in future',
      '1-2-years': 'Wants children in 1–2 years',
      '3-5-years': 'Wants children in 3–5 years',
      unsure: 'Unsure about fertility plans',
      'no-goal': 'Fertility not a goal',
      completed: 'Family completed'
    }[state.fertility] || '';

    const redFlagWarning = state.redFlags.length > 0
      ? `<div class="summary-redflag">⚠️ Red flag symptoms identified — urgent specialist referral recommended</div>`
      : '';

    const fertilityConcerned = ['trying-now', 'future', '1-2-years', '3-5-years', 'unsure'].includes(state.fertility);
    const fertoolCard = fertilityConcerned ? `
      <div class="fertool-card">
        <div class="fertool-card__header">
          <span style="font-size:18px">🔗</span>
          <span class="fertool-card__title">Fertool Integration</span>
        </div>
        <div class="fertool-card__text">
          Your fertility section will include personalised links to <strong>Fertool</strong> for detailed fertility assessment — including AMH interpretation, treatment planning, and timing guidance. Your profile will carry over seamlessly.
        </div>
      </div>` : '';

    return `
      <h2 class="screen-title">Review & Generate</h2>
      <div class="summary-card">
        <div class="summary-card__title">Your Profile Summary</div>
        <p><strong>Age:</strong> ${ageLabel} · <strong>Diagnosis:</strong> ${diagLabel}</p>
        <p><strong>Symptoms:</strong> ${symptomCount} symptom(s) reported${state.lifeImpact.length > 0 ? ` · ${state.lifeImpact.length} area(s) of life affected` : ''}</p>
        ${redFlagWarning}
        <p><strong>Investigations:</strong> ${state.investigations.includes('none') ? 'None yet' : state.investigations.join(', ')}${state.usResult ? ` (result: ${state.usResult})` : ''}</p>
        <p><strong>Treatments tried:</strong>
          ${hormonalTriedCount > 0 ? `${hormonalTriedCount} hormonal` : 'No hormonal'}${hormonalFailedCount > 0 ? ` (${hormonalFailedCount} didn't work/stopped)` : ''}${state.painRelief.length > 0 ? ` · ${state.painRelief.length} pain relief` : ''}${state.nonMedical.length > 0 ? ` · ${state.nonMedical.length} non-medical` : ''}
        </p>
        <p><strong>Surgery:</strong> ${surgLabel}</p>
        <p><strong>Fertility:</strong> ${fertLabel}</p>
        ${state.priorities.length > 0 ? `<p><strong>Priorities:</strong> ${state.priorities.length} selected</p>` : ''}
      </div>

      ${fertoolCard}

      <div class="generate-area">
        <p class="generate-area__hint">
          Your personalised evidence-based report will cover all 8 clinical sections —<br>
          understanding, investigations, medical options, surgery, fertility, pain management, long-term outlook, and next steps.
        </p>
        <button class="btn-generate" id="btn-generate">Generate My Report</button>
        <p class="generate-area__disclaimer">
          This tool provides evidence-based information to prepare you for medical appointments.<br>
          It does not replace advice from your doctor.
        </p>
      </div>
    `;
  },
};

/**
 * EndoTool — Output Generation Engine
 * Assembles the 8-section report from hardcoded content blocks.
 * 
 * Phase 1: Direct assembly (content already in plain language).
 * Phase 2: LLM translation layer will wrap this to synthesise narrative.
 */

const Output = {

  generate(state) {
    const profile = this.buildProfile(state);
    const sections = [
      this.section1(profile),
      this.section2(profile),
      this.section3(profile),
      this.section4(profile),
      this.section5(profile),
      this.section6(profile),
      this.section7(profile),
      this.section8(profile),
    ];

    const redFlagBanner = profile.hasRedFlags ? `
      <div class="alert" style="margin-bottom:28px">
        <span class="alert__icon">⚠️</span>
        <div class="alert__text">${CONTENT.redFlag.banner}</div>
      </div>` : '';

    return `
      <div class="output__header">
        <h1 class="output__title">Your Personalised Evidence-Based Guide</h1>
        <p class="output__subtitle">Based on your profile — covering every aspect of endometriosis management the evidence supports.</p>
      </div>
      ${redFlagBanner}
      ${sections.join('')}
      <div class="output__actions">
        <button class="btn-restart" id="btn-restart">Start Again</button>
      </div>
    `;
  },

  // Build a derived profile object for easier content logic
  buildProfile(state) {
    const isOver35 = state.age === '35-39' || state.age === '40+';
    const isAdolescent = state.age === 'under18';
    const is40Plus = state.age === '40+';
    const allSymptoms = [...state.painSymptoms, ...state.bleedingSymptoms, ...state.bowelBladder, ...state.generalSymptoms];
    const hormonalTried = Object.entries(state.hormonal).filter(([, v]) => v.tried);
    const hormonalFailed = hormonalTried.filter(([, v]) => v.outcome === "Didn't help" || v.outcome === "Side effects");
    const tryingToConceive = state.fertility === 'trying-now';
    const futureFertility = ['future', '1-2-years', '3-5-years', 'unsure'].includes(state.fertility);
    const noFertilityGoal = ['no-goal', 'completed'].includes(state.fertility);
    const hasEndometrioma = state.usResult === 'endometrioma' || state.diagnosis === 'us-confirmed';
    const hasDIE = state.usResult === 'die';
    const hasAdenomyosis = state.diagnosis === 'adenomyosis';
    const noInvestigations = state.investigations.includes('none') || state.investigations.length === 0;
    const hasUS = state.investigations.includes('tvus') || state.investigations.includes('taus');
    const usNormal = state.usResult === 'normal';
    const hasRedFlags = state.redFlags.length > 0;
    const failedMultiple = hormonalFailed.length >= 2;
    const priorSurgeryWithRecurrence = state.surgery === 'recurrence';
    const hadSurgery = ['one-lap', 'multiple', 'recurrence', 'endometrioma-removed'].includes(state.surgery);
    const hasPainRefractory = state.painSymptoms.includes('refractory-pain');
    const hasDyspareunia = state.painSymptoms.includes('dyspareunia');
    const hasFatigue = state.generalSymptoms.includes('fatigue');
    const hasSleep = state.generalSymptoms.includes('sleep');
    const hasMood = state.generalSymptoms.includes('mood');
    const hasCyclicalBowel = state.bowelBladder.includes('cyclical-bowel');
    const hasFamilyHx = state.riskFactors.includes('family-hx');
    const hasRelationshipImpact = state.lifeImpact.includes('relationship');

    return {
      ...state, isOver35, isAdolescent, is40Plus, allSymptoms, hormonalTried, hormonalFailed,
      tryingToConceive, futureFertility, noFertilityGoal, hasEndometrioma, hasDIE, hasAdenomyosis,
      noInvestigations, hasUS, usNormal, hasRedFlags, failedMultiple, priorSurgeryWithRecurrence,
      hadSurgery, hasPainRefractory, hasDyspareunia, hasFatigue, hasSleep, hasMood,
      hasCyclicalBowel, hasFamilyHx, hasRelationshipImpact,
    };
  },

  // ---- Helper to wrap a section ----
  section(number, title, contentParagraphs) {
    return `
      <div class="report-section">
        <div class="report-section__number">Section ${number}</div>
        <h3 class="report-section__title">${title}</h3>
        <div class="report-section__content">
          ${contentParagraphs.map(p => `<p>${p}</p>`).join('')}
        </div>
      </div>`;
  },

  // ---- Helper for Fertool CTA ----
  fertoolCTA(label, title, text) {
    return `
      <div class="fertool-cta">
        <div class="fertool-cta__label">${label}</div>
        <div class="fertool-cta__title">${title}</div>
        <div class="fertool-cta__text">${text}</div>
      </div>`;
  },

  // ---- Helper for GP questions ----
  gpQuestions(questions) {
    return `
      <div class="gp-questions">
        <div class="gp-questions__title">Questions to ask your GP</div>
        <ul class="gp-questions__list">
          ${questions.map(q => `<li>${q}</li>`).join('')}
        </ul>
      </div>`;
  },

  // ================================================
  // SECTION 1: Understanding Your Situation
  // ================================================
  section1(p) {
    const paras = [];
    paras.push(CONTENT.understanding.prevalence);
    paras.push(CONTENT.understanding.delay);
    paras.push(CONTENT.understanding.painNotStage);
    paras.push(CONTENT.understanding.chronic);

    if (p.isAdolescent) paras.push(CONTENT.understanding.validation_adolescent);
    if (p.hasFamilyHx) paras.push(CONTENT.understanding.family_history);
    if (p.hasCyclicalBowel) paras.push(CONTENT.understanding.cyclical_bowel);
    if (p.hasPainRefractory) paras.push(CONTENT.understanding.central_sensitisation);

    paras.push(CONTENT.understanding.comorbidity);
    paras.push(CONTENT.understanding.pain_education);

    return this.section(1, 'Understanding Your Situation', paras);
  },

  // ================================================
  // SECTION 2: Investigations
  // ================================================
  section2(p) {
    const paras = [];

    paras.push(CONTENT.investigations.tvus_first);
    if (p.isAdolescent) paras.push(CONTENT.investigations.adolescent_imaging);
    paras.push(CONTENT.investigations.normal_us);
    paras.push(CONTENT.investigations.mri);
    paras.push(CONTENT.investigations.ca125_no);
    paras.push(CONTENT.investigations.laparoscopy);
    paras.push(CONTENT.investigations.parallel);

    // Profile-specific
    if (p.noInvestigations) paras.push(CONTENT.investigations.no_investigations);
    if (p.hasUS && p.usNormal) paras.push(CONTENT.investigations.us_normal);
    if (p.hasEndometrioma) paras.push(CONTENT.investigations.endometrioma_found);
    if (p.hasDIE) paras.push(CONTENT.investigations.die_found);

    return this.section(2, 'Investigations — What the Evidence Recommends', paras);
  },

  // ================================================
  // SECTION 3: Medical Treatment Options
  // ================================================
  section3(p) {
    const paras = [];

    if (p.tryingToConceive) {
      paras.push(`<div class="blocked-warning"><div class="blocked-warning__text">${CONTENT.medical.blocked_trying}</div></div>`);
      paras.push(CONTENT.medical.nsaids);
    } else {
      paras.push(CONTENT.medical.firstline_intro);
      paras.push(CONTENT.medical.firstline_options);
      paras.push(CONTENT.medical.review_3months);
      paras.push(CONTENT.medical.no_fertility_harm);

      if (p.failedMultiple) {
        paras.push(CONTENT.medical.secondline);
      }

      paras.push(CONTENT.medical.nsaids);
      paras.push(CONTENT.medical.no_opioids);

      if (p.hasPainRefractory) {
        paras.push(CONTENT.medical.neuropathic);
      }
    }

    if (p.hasAdenomyosis) {
      paras.push(CONTENT.medical.adenomyosis);
    }

    return this.section(3, 'Medical Treatment Options', paras);
  },

  // ================================================
  // SECTION 4: Surgical Options
  // ================================================
  section4(p) {
    const paras = [];
    paras.push(CONTENT.surgery.principles);

    if (p.hasEndometrioma) {
      paras.push(CONTENT.surgery.excision_endometrioma);
      if (p.tryingToConceive || p.futureFertility) {
        paras.push(CONTENT.surgery.endometrioma_ivf);
      }
    }

    paras.push(CONTENT.surgery.excision_superficial);

    if (p.tryingToConceive || p.futureFertility) {
      paras.push(CONTENT.surgery.superficial_pain);
    }

    if (p.hasDIE || p.hasRedFlags) {
      paras.push(CONTENT.surgery.die_surgery);
      if (p.tryingToConceive || p.futureFertility) {
        paras.push(CONTENT.surgery.die_fertility);
      }
    }

    if (p.priorSurgeryWithRecurrence || p.surgery === 'multiple') {
      paras.push(CONTENT.surgery.repeat_surgery);
    }

    paras.push(CONTENT.surgery.recurrence_prevention);

    if (p.noFertilityGoal && (p.failedMultiple || p.hadSurgery)) {
      paras.push(CONTENT.surgery.hysterectomy);
    }

    // Fertool handoff
    if (p.hasEndometrioma && (p.tryingToConceive || p.futureFertility)) {
      paras.push(this.fertoolCTA(
        'Fertool — Fertility Assessment',
        'Understand your surgery + fertility options',
        'The decision about whether to have surgery before fertility treatment depends on your ovarian reserve, cyst size, and treatment plan. Get personalised fertility guidance. →'
      ));
    }

    return this.section(4, 'Surgical Options', paras);
  },

  // ================================================
  // SECTION 5: Fertility
  // ================================================
  section5(p) {
    const paras = [];
    paras.push(CONTENT.fertility.basics);
    paras.push(CONTENT.fertility.no_hormones_for_fertility);
    paras.push(CONTENT.fertility.no_pregnancy_as_treatment);

    if (p.tryingToConceive) {
      paras.push(CONTENT.fertility.trying_now);
    }

    if (p.futureFertility && !p.tryingToConceive) {
      paras.push(CONTENT.fertility.future_safe);
      if (p.hasEndometrioma) {
        paras.push(CONTENT.fertility.ovarian_endo);
      }
      if (p.isOver35) {
        paras.push(CONTENT.fertility.over35_urgent);
      }
    }

    if (p.hasEndometrioma || p.isOver35) {
      paras.push(CONTENT.fertility.preservation);
    }

    if (!p.noFertilityGoal) {
      paras.push(CONTENT.fertility.pregnancy_endo);
    }

    // Fertool handoff
    if (p.tryingToConceive) {
      paras.push(this.fertoolCTA(
        'Fertool — Fertility Assessment',
        'Start your fertility assessment',
        'Your fertility journey with endometriosis involves several decisions — treatment options, timing, and approach. Get personalised guidance. →'
      ));
    } else if (p.futureFertility && p.isOver35) {
      paras.push(this.fertoolCTA(
        'Fertool — Fertility Timeline',
        'Understand your fertility timeline',
        'Because you\'re over 35 and want children in the future, timing of fertility preservation is important. Explore your options. →'
      ));
    } else if (p.futureFertility && p.hasEndometrioma) {
      paras.push(this.fertoolCTA(
        'Fertool — Fertility Preservation',
        'Learn about fertility preservation',
        'With an endometrioma, understanding your ovarian reserve helps plan your fertility timeline. →'
      ));
    }

    return this.section(5, 'Fertility — What You Need to Know', paras);
  },

  // ================================================
  // SECTION 6: Pain Management
  // ================================================
  section6(p) {
    const paras = [];
    paras.push(CONTENT.pain.framing);
    paras.push(CONTENT.pain.physio);
    paras.push(CONTENT.pain.cbt);
    paras.push(CONTENT.pain.act);

    if (p.hasMood) {
      paras.push(CONTENT.pain.mhtp);
    }

    if (p.hasSleep) {
      paras.push(CONTENT.pain.cbt_insomnia);
    }

    paras.push(CONTENT.pain.mindfulness);

    if (p.hasDyspareunia || p.hasRelationshipImpact) {
      paras.push(CONTENT.pain.sexual);
    }

    paras.push(CONTENT.pain.acupuncture);
    paras.push(CONTENT.pain.diet);
    paras.push(CONTENT.pain.exercise);
    paras.push(CONTENT.pain.no_tcm);
    paras.push(CONTENT.pain.cannabis);

    if (p.failedMultiple || p.hasPainRefractory || p.priorSurgeryWithRecurrence) {
      paras.push(CONTENT.pain.mdt);
    }

    paras.push(CONTENT.pain.cdmp);

    return this.section(6, 'Pain Management — The Full Picture', paras);
  },

  // ================================================
  // SECTION 7: Long-Term Outlook
  // ================================================
  section7(p) {
    const paras = [];

    if (p.hadSurgery) {
      paras.push(CONTENT.longterm.recurrence);
    }

    paras.push(CONTENT.longterm.asymptomatic);

    if (p.hasDIE || p.hasEndometrioma) {
      paras.push(CONTENT.longterm.monitoring);
    }

    paras.push(CONTENT.longterm.comorbidities);
    paras.push(CONTENT.longterm.cancer);

    return this.section(7, 'Long-Term Outlook & Monitoring', paras);
  },

  // ================================================
  // SECTION 8: Support, Resources & Next Steps
  // ================================================
  section8(p) {
    const paras = [];

    // Build personalised GP question list
    const gpQs = [];
    if (p.noInvestigations) gpQs.push('"Can you arrange a transvaginal ultrasound?"');
    if (p.hasEndometrioma || p.hasDIE || p.hasRedFlags) gpQs.push('"Can you refer me to a specialist endometriosis service?"');
    if (!p.tryingToConceive && p.hormonalTried.length === 0) gpQs.push('"I\'d like to discuss hormonal treatment options."');
    if (p.hasDyspareunia || p.allSymptoms.includes('pelvic-pain')) gpQs.push('"Can you refer me for pelvic floor physiotherapy?"');
    if (p.allSymptoms.length >= 3) gpQs.push('"Can you set up a Chronic Disease Management Plan?"');
    if (p.hasMood || p.lifeImpact.includes('mental-health')) gpQs.push('"Can you set up a Mental Health Treatment Plan?"');
    if (p.tryingToConceive) gpQs.push('"Can you refer me to a fertility specialist?"');
    if ((p.hasEndometrioma || p.hadSurgery) && (p.tryingToConceive || p.futureFertility)) gpQs.push('"Can I have an AMH test to check my ovarian reserve?"');
    if (p.isAdolescent) gpQs.push('"Can you refer me to a paediatric or adolescent gynaecologist?"');
    if (p.failedMultiple) gpQs.push('"I\'ve tried several treatments without success — what are my next options?"');

    if (gpQs.length > 0) {
      paras.push(this.gpQuestions(gpQs));
    }

    paras.push(CONTENT.nextsteps.referral_criteria);

    if (p.hasDIE || p.hasRedFlags) {
      paras.push(CONTENT.nextsteps.specialist_endo);
    }

    paras.push(CONTENT.nextsteps.resources_au);

    // General Fertool link
    if (p.futureFertility || p.tryingToConceive) {
      paras.push(this.fertoolCTA(
        'Fertool',
        'Explore your fertility options in detail',
        'Our fertility assessment tool provides personalised guidance based on your specific situation — AMH interpretation, treatment planning, and timing. →'
      ));
    }

    return this.section(8, 'Support, Resources & Next Steps', paras);
  },
};

/**
 * EndoTool — Main Application Controller
 * Manages state, navigation, event delegation, and output generation.
 */

(function () {
  'use strict';

  // ---- State ---- //
  const state = {
    screen: 0,
    age: null,
    diagnosis: null,
    painSymptoms: [],
    bleedingSymptoms: [],
    bowelBladder: [],
    generalSymptoms: [],
    lifeImpact: [],
    riskFactors: [],
    redFlags: [],
    investigations: [],
    usResult: null,
    painRelief: [],
    hormonal: {
      coc: { tried: false, outcome: null },
      pop: { tried: false, outcome: null },
      mirena: { tried: false, outcome: null },
      implant: { tried: false, outcome: null },
      depo: { tried: false, outcome: null },
      gnrha: { tried: false, outcome: null },
      gnrhant: { tried: false, outcome: null },
    },
    nonMedical: [],
    surgery: null,
    fertility: null,
    priorities: [],
  };

  // ---- DOM refs ---- //
  const contentEl = document.getElementById('content');
  const outputEl = document.getElementById('output');
  const navEl = document.getElementById('nav');
  const btnBack = document.getElementById('btn-back');
  const btnNext = document.getElementById('btn-next');
  const progressSegments = document.querySelectorAll('.progress__segment');
  const stepCount = document.querySelector('.progress__step-count');
  const stepName = document.querySelector('.progress__step-name');
  const headerEl = document.querySelector('.header');
  const progressEl = document.querySelector('.progress');

  // ---- Navigation ---- //
  function canProceed() {
    switch (state.screen) {
      case 0: return state.age && state.diagnosis;
      case 1: return true; // symptoms optional
      case 2: return true; // investigations optional
      case 3: return state.surgery !== null;
      case 4: return state.fertility !== null;
      default: return true;
    }
  }

  function updateNav() {
    btnBack.style.visibility = state.screen > 0 ? 'visible' : 'hidden';

    if (state.screen === 5) {
      // Review screen — hide normal nav
      btnNext.style.display = 'none';
    } else {
      btnNext.style.display = '';
      btnNext.disabled = !canProceed();
      btnNext.textContent = state.screen === 4 ? 'Review →' : 'Continue →';
    }
  }

  function updateProgress() {
    const current = Math.min(state.screen, 4);
    progressSegments.forEach((seg, i) => {
      seg.classList.toggle('active', i <= current);
    });
    stepCount.textContent = state.screen <= 4 ? `Step ${state.screen + 1} of 5` : 'Review';
    stepName.textContent = state.screen <= 4 ? SCREEN_NAMES[state.screen] : 'Summary';
  }

  function renderScreen(direction) {
    const animClass = direction === 'forward' ? 'anim-forward' : direction === 'back' ? 'anim-back' : 'anim-fade';

    const renderFn = `screen${state.screen}`;
    if (Screens[renderFn]) {
      contentEl.innerHTML = Screens[renderFn](state);
    }

    contentEl.className = `content ${animClass}`;
    contentEl.scrollTop = 0;
    window.scrollTo({ top: 0, behavior: 'smooth' });

    updateNav();
    updateProgress();
    attachScreenEvents();
  }

  function navigate(direction) {
    if (direction === 'forward' && !canProceed()) return;
    state.screen += direction === 'forward' ? 1 : -1;
    renderScreen(direction);
  }

  // ---- Event delegation ---- //
  function attachScreenEvents() {
    // Generate button (on review screen)
    const generateBtn = document.getElementById('btn-generate');
    if (generateBtn) {
      generateBtn.addEventListener('click', generateReport);
    }
  }

  // Content area event delegation
  contentEl.addEventListener('click', function (e) {
    // --- Handle option clicks (checkbox/radio) ---
    const option = e.target.closest('.option');
    if (option) {
      const group = option.dataset.group;
      const id = option.dataset.id;
      if (!group || !id) return;

      const input = option.querySelector('input');
      const isRadio = input && input.type === 'radio';

      if (isRadio) {
        // Radio: set single value
        state[group] = id;
      } else {
        // Checkbox: toggle in array
        if (group === 'hormonal') {
          state.hormonal[id].tried = !state.hormonal[id].tried;
          if (!state.hormonal[id].tried) state.hormonal[id].outcome = null;
        } else if (group === 'investigations') {
          // "None" is exclusive
          if (id === 'none') {
            state.investigations = state.investigations.includes('none') ? [] : ['none'];
          } else {
            const arr = state.investigations.filter(v => v !== 'none');
            const idx = arr.indexOf(id);
            if (idx >= 0) arr.splice(idx, 1);
            else arr.push(id);
            state.investigations = arr;
          }
        } else {
          const arr = state[group];
          if (arr) {
            const idx = arr.indexOf(id);
            if (idx >= 0) arr.splice(idx, 1);
            else arr.push(id);
          }
        }
      }

      // Re-render current screen to reflect changes
      renderScreen(null);
      return;
    }

    // --- Handle outcome pill clicks ---
    const pill = e.target.closest('.outcome-pill');
    if (pill) {
      const id = pill.dataset.id;
      const outcome = pill.dataset.outcome;
      if (id && outcome && state.hormonal[id]) {
        state.hormonal[id].outcome = outcome;
        renderScreen(null);
      }
      return;
    }
  });

  // Nav buttons
  btnNext.addEventListener('click', () => navigate('forward'));
  btnBack.addEventListener('click', () => navigate('back'));

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && canProceed() && state.screen < 5) {
      navigate('forward');
    }
  });

  // ---- Report generation ---- //
  function generateReport() {
    // Hide intake UI
    headerEl.style.display = 'none';
    progressEl.style.display = 'none';
    contentEl.style.display = 'none';
    navEl.style.display = 'none';

    // Show output
    outputEl.style.display = '';
    outputEl.innerHTML = Output.generate(state);
    outputEl.className = 'output anim-fade';

    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Restart button
    const restartBtn = document.getElementById('btn-restart');
    if (restartBtn) {
      restartBtn.addEventListener('click', restart);
    }

    // Log profile for debugging / Phase 2 API integration
    console.log('EndoTool Profile:', JSON.stringify(state, null, 2));
  }

  function restart() {
    // Reset state
    state.screen = 0;
    state.age = null;
    state.diagnosis = null;
    state.painSymptoms = [];
    state.bleedingSymptoms = [];
    state.bowelBladder = [];
    state.generalSymptoms = [];
    state.lifeImpact = [];
    state.riskFactors = [];
    state.redFlags = [];
    state.investigations = [];
    state.usResult = null;
    state.painRelief = [];
    Object.keys(state.hormonal).forEach(k => {
      state.hormonal[k] = { tried: false, outcome: null };
    });
    state.nonMedical = [];
    state.surgery = null;
    state.fertility = null;
    state.priorities = [];

    // Show intake UI
    headerEl.style.display = '';
    progressEl.style.display = '';
    contentEl.style.display = '';
    navEl.style.display = '';
    outputEl.style.display = 'none';

    renderScreen('forward');
  }

  // ---- Init ---- //
  renderScreen('forward');

})();
  </script>
</body>
</html>
